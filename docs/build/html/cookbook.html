<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cookbook &mdash; PyAnomaly 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=14fdb342" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=f2a433a1"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Bulding Your Own" href="building_your_own.html" />
    <link rel="prev" title="Installation" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            PyAnomaly
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#main-features">Main Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#coverage">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#structure">Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#system-requirement">System Requirement</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#comparison-to-other-sources">Comparison to Other Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#useful-links">Useful Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#glossary">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#contributors">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#featured-in">Featured In</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How to Use</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html#generating-characteristics">Generating Characteristics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.example1">Example 1. Generating firm characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.example2">Example 2. Sorting-based portfolio analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.example3">Example 3. Quantile portfolio construction and evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.example4">Example 4. Defining a new characteristic</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.example5">Example 5. Firm characteristics using year-end ME</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.example6">Example 6. Playing with Panel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.example7">Example 7. Table download</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="building_your_own.html">Bulding Your Own</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pyanomaly_edited.html">pyanomaly</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PyAnomaly</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Cookbook</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/cookbook.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cookbook">
<span id="id1"></span><h1>Cookbook<a class="headerlink" href="#cookbook" title="Link to this heading"></a></h1>
<p>All the examples presented here can be found in <a class="reference external" href="https://github.com/chulwoohan/pyanomaly">examples</a>.
For the details of each function or class, refer to the <a class="reference internal" href="pyanomaly_edited.html#pyanomaly"><span class="std std-ref">API</span></a> documentation.
All examples were tested on a desktop with 12th Gen Intel(R) Core(TM) i9-12900KS and 128GB RAM and 1GB network</p>
<section id="module-examples.example1">
<span id="example-1-generating-firm-characteristics"></span><h2>Example 1. Generating firm characteristics<a class="headerlink" href="#module-examples.example1" title="Link to this heading"></a></h2>
<p>Firm characteristics generation</p>
<p>This example shows the full process of i) data download, ii) factor generation, and iii) firm characteristic
generation.
In this example,</p>
<blockquote>
<div><ul class="simple">
<li><p>Funda is merged with fundq to create quarterly updated annual accounting data.</p></li>
<li><p>Funda and fundq are assumed to be available 4 months later.</p></li>
<li><p>The latest market equity (me) is used when generating firm characteristics.</p></li>
<li><p>All firm characteristics defined in PyAnomaly are generated.</p></li>
</ul>
</div></blockquote>
<p>Generated factors are saved to ‘./output/factors_monthly’ and ‘./output/factors_daily’, and firm characteristics are
saved to ‘./output/merge’.</p>
<p>Processing time: approx. 45 minutes to download data and 15 minutes for the rest.</p>
<section id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Link to this heading"></a></h3>
<p>Import packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyanomaly.globals</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyanomaly.wrdsdata</span> <span class="kn">import</span> <span class="n">WRDS</span>
<span class="kn">from</span> <span class="nn">pyanomaly.characteristics</span> <span class="kn">import</span> <span class="n">FUNDA</span><span class="p">,</span> <span class="n">FUNDQ</span><span class="p">,</span> <span class="n">CRSPM</span><span class="p">,</span> <span class="n">CRSPD</span><span class="p">,</span> <span class="n">Merge</span>
<span class="kn">from</span> <span class="nn">pyanomaly.factors</span> <span class="kn">import</span> <span class="n">make_all_factor_portfolios</span>
<span class="kn">from</span> <span class="nn">pyanomaly.analytics</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Set log file path and start a timer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set log file path as config.log_dir + this module name.</span>
<span class="n">set_log_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>  <span class="c1"># You can also give a different log file name: e.g., set_log_path(&#39;logfile.log&#39;)</span>

<span class="c1"># Start timer.</span>
<span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;Example 1.&#39;</span><span class="p">)</span>

<span class="c1"># To replicate JKP&#39;s SAS code as closely as possible, uncomment the following line.</span>
<span class="c1"># set_config(replicate_jkp=True)</span>
</pre></div>
</div>
</section>
<section id="download-data-frm-wrds">
<h3>Download data frm WRDS<a class="headerlink" href="#download-data-frm-wrds" title="Link to this heading"></a></h3>
<p><a class="reference internal" href="pyanomaly_edited.html#pyanomaly.wrdsdata.WRDS" title="pyanomaly.wrdsdata.WRDS"><code class="xref py py-class docutils literal notranslate"><span class="pre">WRDS</span></code></a> is a class to download data from WRDS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span> <span class="o">=</span> <span class="n">WRDS</span><span class="p">(</span><span class="n">wrds_username</span><span class="p">)</span>  <span class="c1"># Use your WRDS user id.</span>

<span class="c1"># Download all necessary data asynchronously.</span>
<span class="c1"># If network is slow or memory is insufficient, set run_in_executer=False.</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">download_all</span><span class="p">(</span><span class="n">run_in_executer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create crspm(d) from m(d)sf and m(d)seall and add gvkey to them.</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">preprocess_crsp</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="factor-generation">
<h3>Factor generation<a class="headerlink" href="#factor-generation" title="Link to this heading"></a></h3>
<p>Make factor portfolios: FF3, FF5, HXZ4, and SY4.
These are used in some firm characteristics, such as the residual momentum.</p>
<p>References: <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.factors.make_all_factor_portfolios" title="pyanomaly.factors.make_all_factor_portfolios"><code class="xref py py-func docutils literal notranslate"><span class="pre">make_all_factor_portfolios()</span></code></a>, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.factors.make_factor_portfolios" title="pyanomaly.factors.make_factor_portfolios"><code class="xref py py-func docutils literal notranslate"><span class="pre">make_factor_portfolios()</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make_all_factor_portfolios</span><span class="p">(</span><span class="n">monthly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">daily</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Monthly and daily factors</span>
</pre></div>
</div>
</section>
<section id="firm-characteristic-generation">
<h3>Firm characteristic generation<a class="headerlink" href="#firm-characteristic-generation" title="Link to this heading"></a></h3>
<p>Firm characteristics are generated by <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.characteristics.FUNDA" title="pyanomaly.characteristics.FUNDA"><code class="xref py py-class docutils literal notranslate"><span class="pre">FUNDA</span></code></a>, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.characteristics.FUNDQ" title="pyanomaly.characteristics.FUNDQ"><code class="xref py py-class docutils literal notranslate"><span class="pre">FUNDQ</span></code></a>, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.characteristics.CRSPM" title="pyanomaly.characteristics.CRSPM"><code class="xref py py-class docutils literal notranslate"><span class="pre">CRSPM</span></code></a>, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.characteristics.CRSPD" title="pyanomaly.characteristics.CRSPD"><code class="xref py py-class docutils literal notranslate"><span class="pre">CRSPD</span></code></a>,
and <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.characteristics.Merge" title="pyanomaly.characteristics.Merge"><code class="xref py py-class docutils literal notranslate"><span class="pre">Merge</span></code></a> classes.</p>
<p>To generate characteristics in a certain column of mapping.xlsx, set <code class="docutils literal notranslate"><span class="pre">alias</span></code> = column name.
For instance, <code class="docutils literal notranslate"><span class="pre">alias</span> <span class="pre">=</span> <span class="pre">'jkp'</span></code> will generated firm characteristics defined in ‘jkp’ column.
Setting <code class="docutils literal notranslate"><span class="pre">alias</span> <span class="pre">=</span> <span class="pre">None</span></code> will generate all available firm characteristics.
Note that some firm characteristics will be created twice using different implementations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alias</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># Start date (&#39;yyyy-mm-dd&#39;). Set to None to create characteristics from as early as possible.</span>
<span class="n">sdate</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Generate firm characteristics from crspm.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crspm</span> <span class="o">=</span> <span class="n">CRSPM</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>

<span class="c1"># Load crspm.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># Filter data: shrcd in [10, 11, 12]</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>

<span class="c1"># Fill missing months by populating the data.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># Merge crspm with the monthly factors generated earlier.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">merge_with_factors</span><span class="p">()</span>

<span class="c1"># Display the firm characteristics to be generated.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">show_available_chars</span><span class="p">()</span>

<span class="c1"># Create characteristics.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="c1"># Postprocessing: delete temporary variables and inspect the generated data.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
</pre></div>
</div>
<p>Generate firm characteristics from crspd.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crspd</span> <span class="o">=</span> <span class="n">CRSPD</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>

<span class="c1"># Load crspd.</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># Filter data: shrcd in [10, 11, 12]</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># Merge crspd with the daily factors generated earlier.</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">merge_with_factors</span><span class="p">()</span>

<span class="c1"># Display the firm characteristics to be generated.</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">show_available_chars</span><span class="p">()</span>

<span class="c1"># Create characteristics.</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="c1"># Postprocessing: delete temporary variables and inspect the generated data.</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>

<span class="c1"># Delete raw crspd data to save memory.</span>
<span class="k">del</span> <span class="n">crspd</span><span class="o">.</span><span class="n">cd</span>
</pre></div>
</div>
<p>Generate firm characteristics from fundq.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fundq</span> <span class="o">=</span> <span class="n">FUNDQ</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>

<span class="c1"># Load fundq.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># fundq has some duplicates (same datedate/gvkey). Drop duplicates.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">remove_duplicates</span><span class="p">()</span>

<span class="c1"># Convert values in another currency (currently only CAD) to USD.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">()</span>

<span class="c1"># Populate data to monthly.</span>
<span class="c1"># limit=3: Forward fill up to 3 months.</span>
<span class="c1"># lag=4: Shift data 4 months, i.e., data is available 4 months later.</span>
<span class="c1"># new_date_col=&#39;date&#39;: Populated data has index &#39;date&#39;/&#39;gvkey&#39;, and &#39;datadate&#39; becomes a column.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">MONTHLY</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">new_date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1"># Make quarterly variables from ytd variables and use them to fill missing quarterly variables.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">create_qitems_from_yitems</span><span class="p">()</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># Display the firm characteristics to be generated.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">show_available_chars</span><span class="p">()</span>

<span class="c1"># Create characteristics.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="c1"># Postprocessing: delete temporary variables and inspect the generated data.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
</pre></div>
</div>
<p>Generate firm characteristics from funda.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">funda</span> <span class="o">=</span> <span class="n">FUNDA</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>

<span class="c1"># Load funda.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># Convert values in another currency (currently only CAD) to USD.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">()</span>

<span class="c1"># Populate data to monthly.</span>
<span class="c1"># limit=12: Forward fill up to 12 months.</span>
<span class="c1"># lag=4: Shift data 4 months, i.e., data is available 4 months later.</span>
<span class="c1"># new_date_col=&#39;date&#39;: Populated data has index &#39;date&#39;/&#39;gvkey&#39;, and &#39;datadate&#39; becomes a column.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">MONTHLY</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">new_date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1"># Generate quarterly-updated funda data from fundq and merge them with funda.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">merge_with_fundq</span><span class="p">(</span><span class="n">fundq</span><span class="p">)</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># Add the market equity of crspm to funda.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">add_crsp_me</span><span class="p">(</span><span class="n">crspm</span><span class="p">)</span>

<span class="c1"># Display the firm characteristics to be generated.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">show_available_chars</span><span class="p">()</span>

<span class="c1"># Create characteristics.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="c1"># Postprocessing: delete temporary variables and inspect the generated data.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
</pre></div>
</div>
<p>Merge FUNDA, FUNDQ, CRSPM, and CRSPD and generate firm characteristics that require data from multiple data sources.
Merge.data contains all firm characteristics and raw data from FUNDA, FUNDQ, CRSPM, AND CRSPD.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">merge</span> <span class="o">=</span> <span class="n">Merge</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

<span class="c1"># Merge all data together.</span>
<span class="n">merge</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">crspm</span><span class="p">,</span> <span class="n">crspd</span><span class="p">,</span> <span class="n">funda</span><span class="p">,</span> <span class="n">fundq</span><span class="p">)</span>

<span class="c1"># Display the firm characteristics to be generated.</span>
<span class="n">merge</span><span class="o">.</span><span class="n">show_available_chars</span><span class="p">()</span>

<span class="c1"># Create characteristics.</span>
<span class="n">merge</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="c1"># Postprocessing: delete temporary variables and inspect the generated data.</span>
<span class="n">merge</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>

<span class="c1"># Save the results to config.output_dir + &#39;merge&#39;.</span>
<span class="c1"># The default behavior of Panel.save() is to save all the columns of Panel.data.</span>
<span class="c1"># You can reduce file size by choosing columns to save. The following code saves firm characteristics + columns.</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gvkey&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;exret&#39;</span><span class="p">,</span> <span class="s1">&#39;rf&#39;</span><span class="p">]</span>
<span class="n">merge</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">other_columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;End of Example 1.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="module-examples.example2">
<span id="example-2-sorting-based-portfolio-analysis"></span><h2>Example 2. Sorting-based portfolio analysis<a class="headerlink" href="#module-examples.example2" title="Link to this heading"></a></h2>
<p>Sorting-based portfolio analysis.</p>
<p>This example demonstrates how to construct quantile portfolios and carry out 1-D or 2-D sorts.</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>Quintile portfolios will be generated from the 12-month momentum and their mean returns and t-values will be
computed.</p></li>
<li><p>5x5 2-D sort will be conducted on momentum and size.</p></li>
<li><p>Firm-level cross-sectional regression will be conducted.</p></li>
<li><p>Factor regressions will be carried out using FF 3-factors.</p></li>
</ol>
</div></blockquote>
<ul class="simple">
<li><p>It is assumed that the firm characteristic has been created and saved to config.output_dir + ‘crspm’.</p></li>
</ul>
<p>See also <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.factors.make_char_portfolios" title="pyanomaly.factors.make_char_portfolios"><code class="xref py py-func docutils literal notranslate"><span class="pre">make_char_portfolios()</span></code></a> for characteristic portfolio creation replicating JKP’s SAS code.</p>
<p>Processing time: approx. 10 seconds.</p>
<section id="id2">
<h3>Initialization<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p>Import packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyanomaly.fileio</span> <span class="kn">import</span> <span class="n">read_from_file</span>
<span class="kn">from</span> <span class="nn">pyanomaly.analytics</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Set log file path and start a timer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">set_log_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;Example 2&#39;</span><span class="p">)</span>

<span class="c1"># Jitted functions are slow when first called due to compile time. This example runs faster by disabling jit.</span>
<span class="n">set_config</span><span class="p">(</span><span class="n">disable_jit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="set-variables">
<h3>Set variables<a class="headerlink" href="#set-variables" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;ret_12_1&#39;</span>  <span class="c1"># 12-month momentum</span>
<span class="n">char_class</span> <span class="o">=</span> <span class="n">char</span> <span class="o">+</span> <span class="s1">&#39;_class&#39;</span>  <span class="c1"># Momentum class column</span>
<span class="n">ret_col</span> <span class="o">=</span> <span class="s1">&#39;exret&#39;</span>  <span class="c1"># Return column</span>
<span class="n">weight_col</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span>  <span class="c1"># Market equity column</span>
<span class="n">split</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Qintile. You can also do split = [0.2, 0.4, 0.6, 0.8].</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]</span>  <span class="c1"># Momentum portfolio names: &#39;H-L&#39; for long short.</span>
</pre></div>
</div>
</section>
<section id="load-and-prepare-data">
<h3>Load and prepare data<a class="headerlink" href="#load-and-prepare-data" title="Link to this heading"></a></h3>
<p>References: <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.datatools.shift" title="pyanomaly.datatools.shift"><code class="xref py py-func docutils literal notranslate"><span class="pre">datatools.shift()</span></code></a>, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.datatools.filter" title="pyanomaly.datatools.filter"><code class="xref py py-func docutils literal notranslate"><span class="pre">filter()</span></code></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read crspm data (not raw data but the output data).</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="s1">&#39;crspm&#39;</span><span class="p">)</span>

<span class="c1"># Shift data except for return so that all the variables at t are as of t-1 and the return is over t-1 to t.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">shift</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">excl_cols</span><span class="o">=</span><span class="p">[</span><span class="n">ret_col</span><span class="p">])</span>

<span class="c1"># Drop nan returns and weights.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">])</span>

<span class="c1"># If you want to exclude bottom 20% based on NYSE size...</span>
<span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;crspm shape before size filtering: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">exchcd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">weight_col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># NYSE me</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ginfo</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;crspm shape after size filtering: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">22</span> <span class="mi">14</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span> <span class="n">crspm</span> <span class="n">shape</span> <span class="n">before</span> <span class="n">size</span> <span class="n">filtering</span><span class="p">:</span> <span class="p">(</span><span class="mi">3958767</span><span class="p">,</span> <span class="mi">76</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">22</span> <span class="mi">14</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span> <span class="n">crspm</span> <span class="n">shape</span> <span class="n">after</span> <span class="n">size</span> <span class="n">filtering</span><span class="p">:</span> <span class="p">(</span><span class="mi">1752862</span><span class="p">,</span> <span class="mi">77</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="d-sort">
<h3>1-D sort<a class="headerlink" href="#d-sort" title="Link to this heading"></a></h3>
<p>References: <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.datatools.classify" title="pyanomaly.datatools.classify"><code class="xref py py-func docutils literal notranslate"><span class="pre">classify()</span></code></a>, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.analytics.one_dim_sort" title="pyanomaly.analytics.one_dim_sort"><code class="xref py py-func docutils literal notranslate"><span class="pre">one_dim_sort()</span></code></a>, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.analytics.time_series_average" title="pyanomaly.analytics.time_series_average"><code class="xref py py-func docutils literal notranslate"><span class="pre">time_series_average()</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;1D sort start.&#39;</span><span class="p">)</span>

<span class="c1"># Classify stocks on each date on momentum. class 0: highest momentum, 5: lowest momentum.</span>
<span class="n">data</span><span class="p">[</span><span class="n">char_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">char</span><span class="p">],</span> <span class="n">split</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ginfo</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1"># Make value-weighted quantile portfolios.</span>
<span class="c1"># Set weight_col to None for equal-weight portfolios.</span>
<span class="c1"># qpfs will have index = date/char_class and columns = [ret_col]</span>
<span class="n">qpfs</span> <span class="o">=</span> <span class="n">one_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="n">weight_col</span><span class="p">)</span>

<span class="c1"># You can add more columns to the portfolios. Here, I add signal (mean of the characteristic) and</span>
<span class="c1"># n_firms (number of firms).</span>
<span class="n">qpfs</span><span class="p">[[</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;n_firms&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">one_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>

<span class="c1"># If you want to see the average size and price of the portfolios...</span>
<span class="n">qpfs</span><span class="p">[[</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;prc&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">one_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="p">[</span><span class="n">weight_col</span><span class="p">,</span> <span class="s1">&#39;prc&#39;</span><span class="p">])</span>

<span class="c1"># Rename the portfolios. Without this, the names are 0, 1, ...</span>
<span class="n">relabel_class</span><span class="p">(</span><span class="n">qpfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

<span class="c1"># Check the result.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quantile portfolios sorted on </span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">qpfs</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Quantile</span> <span class="n">portfolios</span> <span class="nb">sorted</span> <span class="n">on</span> <span class="n">ret_12_1</span>
                       <span class="n">exret</span>  <span class="n">signal</span>  <span class="n">n_firms</span>      <span class="n">size</span>      <span class="n">prc</span>
<span class="n">date</span>       <span class="n">ret_12_1_class</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="n">H</span>              <span class="o">-</span><span class="mf">0.008</span>   <span class="mf">0.479</span>       <span class="mi">72</span>    <span class="mf">83.725</span>   <span class="mf">73.075</span>
           <span class="mi">2</span>               <span class="mf">0.006</span>   <span class="mf">0.145</span>       <span class="mi">72</span>   <span class="mf">137.217</span>   <span class="mf">92.345</span>
           <span class="mi">3</span>               <span class="mf">0.001</span>   <span class="mf">0.010</span>       <span class="mi">71</span>    <span class="mf">85.660</span>   <span class="mf">81.256</span>
           <span class="mi">4</span>              <span class="o">-</span><span class="mf">0.004</span>  <span class="o">-</span><span class="mf">0.107</span>       <span class="mi">72</span>    <span class="mf">53.240</span>   <span class="mf">54.126</span>
           <span class="n">L</span>              <span class="o">-</span><span class="mf">0.007</span>  <span class="o">-</span><span class="mf">0.333</span>       <span class="mi">72</span>    <span class="mf">24.329</span>   <span class="mf">34.560</span>
           <span class="n">H</span><span class="o">-</span><span class="n">L</span>            <span class="o">-</span><span class="mf">0.001</span>   <span class="mf">0.812</span>        <span class="mi">0</span>    <span class="mf">59.396</span>   <span class="mf">38.515</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span> <span class="n">H</span>               <span class="mf">0.055</span>   <span class="mf">0.447</span>       <span class="mi">74</span>    <span class="mf">93.941</span>   <span class="mf">81.642</span>
                          <span class="o">...</span>     <span class="o">...</span>      <span class="o">...</span>       <span class="o">...</span>      <span class="o">...</span>
           <span class="n">H</span><span class="o">-</span><span class="n">L</span>             <span class="mf">0.038</span>   <span class="mf">1.041</span>        <span class="mi">0</span> <span class="mf">20643.687</span>   <span class="mf">81.385</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="n">H</span>               <span class="mf">0.040</span>   <span class="mf">0.575</span>      <span class="mi">449</span> <span class="mf">33467.685</span>  <span class="mf">119.837</span>
           <span class="mi">2</span>               <span class="mf">0.035</span>   <span class="mf">0.083</span>      <span class="mi">449</span> <span class="mf">31027.949</span> <span class="mf">1333.695</span>
           <span class="mi">3</span>               <span class="mf">0.045</span>  <span class="o">-</span><span class="mf">0.067</span>      <span class="mi">449</span> <span class="mf">22789.652</span>  <span class="mf">101.212</span>
           <span class="mi">4</span>               <span class="mf">0.074</span>  <span class="o">-</span><span class="mf">0.207</span>      <span class="mi">449</span> <span class="mf">14269.428</span>   <span class="mf">64.336</span>
           <span class="n">L</span>               <span class="mf">0.118</span>  <span class="o">-</span><span class="mf">0.425</span>      <span class="mi">450</span>  <span class="mf">5509.468</span>   <span class="mf">35.076</span>
           <span class="n">H</span><span class="o">-</span><span class="n">L</span>            <span class="o">-</span><span class="mf">0.077</span>   <span class="mf">1.000</span>       <span class="o">-</span><span class="mi">1</span> <span class="mf">27958.216</span>   <span class="mf">84.760</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the time-series mean and t-value of the returns of the quantile portfolios.</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">tval</span> <span class="o">=</span> <span class="n">time_series_average</span><span class="p">(</span><span class="n">qpfs</span><span class="p">[</span><span class="n">ret_col</span><span class="p">],</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxlags&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Mean of portfolio returns sorted on </span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">tval</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;1D sort end.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Mean</span> <span class="n">of</span> <span class="n">portfolio</span> <span class="n">returns</span> <span class="nb">sorted</span> <span class="n">on</span> <span class="n">ret_12_1</span>
                <span class="n">mean</span>  <span class="n">t</span><span class="o">-</span><span class="n">val</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>              <span class="mf">0.011</span>  <span class="mf">5.503</span>
<span class="mi">2</span>              <span class="mf">0.008</span>  <span class="mf">4.899</span>
<span class="mi">3</span>              <span class="mf">0.006</span>  <span class="mf">3.727</span>
<span class="mi">4</span>              <span class="mf">0.006</span>  <span class="mf">3.269</span>
<span class="n">L</span>              <span class="mf">0.003</span>  <span class="mf">1.478</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>            <span class="mf">0.007</span>  <span class="mf">4.335</span>
</pre></div>
</div>
</section>
<section id="id3">
<h3>2-D sort<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>References: <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.analytics.two_dim_sort" title="pyanomaly.analytics.two_dim_sort"><code class="xref py py-func docutils literal notranslate"><span class="pre">two_dim_sort()</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;2D sort start.&#39;</span><span class="p">)</span>

<span class="c1"># Make 5x5 portfolios on momentum and size.</span>
<span class="n">char2</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span>  <span class="c1"># Market equity</span>
<span class="n">char_class2</span> <span class="o">=</span> <span class="n">char2</span> <span class="o">+</span> <span class="s1">&#39;_class&#39;</span>  <span class="c1"># Size class column</span>
<span class="n">split2</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Quintiles</span>
<span class="n">labels2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;S-B&#39;</span><span class="p">]</span>  <span class="c1"># Size portfolio names</span>

<span class="c1"># Classify stocks on each date on size. class 0: smallest, 5: biggest.</span>
<span class="n">data</span><span class="p">[</span><span class="n">char_class2</span><span class="p">]</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">char2</span><span class="p">],</span> <span class="n">split2</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ginfo</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1"># Make 5x5 value-weighted portfolios.</span>
<span class="c1"># qpfs2 will have index = date/char_class and columns = char_class2.</span>
<span class="n">qpfs2</span> <span class="o">=</span> <span class="n">two_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">char_class2</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="n">weight_col</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Rename the portfolios.</span>
<span class="n">relabel_class</span><span class="p">(</span><span class="n">qpfs2</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="n">relabel_class</span><span class="p">(</span><span class="n">qpfs2</span><span class="p">,</span> <span class="n">labels2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Calculate the time-series mean and t-value of the returns of the quantile portfolios.</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">tval</span> <span class="o">=</span> <span class="n">time_series_average</span><span class="p">(</span><span class="n">qpfs2</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxlags&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mean of portfolio returns sorted on </span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">char2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">t-stat&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tval</span><span class="p">)</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;2D sort end.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mean</span> <span class="n">of</span> <span class="n">portfolio</span> <span class="n">returns</span> <span class="nb">sorted</span> <span class="n">on</span> <span class="n">ret_12_1</span> <span class="ow">and</span> <span class="n">me</span>

<span class="n">Mean</span>
<span class="n">me_class</span>           <span class="n">S</span>     <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>     <span class="n">B</span>    <span class="n">S</span><span class="o">-</span><span class="n">B</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>              <span class="mf">0.014</span> <span class="mf">0.014</span> <span class="mf">0.014</span> <span class="mf">0.012</span> <span class="mf">0.010</span>  <span class="mf">0.004</span>
<span class="mi">2</span>              <span class="mf">0.012</span> <span class="mf">0.010</span> <span class="mf">0.009</span> <span class="mf">0.009</span> <span class="mf">0.008</span>  <span class="mf">0.004</span>
<span class="mi">3</span>              <span class="mf">0.011</span> <span class="mf">0.009</span> <span class="mf">0.008</span> <span class="mf">0.008</span> <span class="mf">0.006</span>  <span class="mf">0.005</span>
<span class="mi">4</span>              <span class="mf">0.009</span> <span class="mf">0.008</span> <span class="mf">0.007</span> <span class="mf">0.006</span> <span class="mf">0.006</span>  <span class="mf">0.004</span>
<span class="n">L</span>              <span class="mf">0.003</span> <span class="mf">0.004</span> <span class="mf">0.004</span> <span class="mf">0.004</span> <span class="mf">0.003</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>            <span class="mf">0.011</span> <span class="mf">0.010</span> <span class="mf">0.009</span> <span class="mf">0.008</span> <span class="mf">0.007</span>  <span class="mf">0.004</span>

<span class="n">t</span><span class="o">-</span><span class="n">stat</span>
<span class="n">me_class</span>           <span class="n">S</span>     <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>     <span class="n">B</span>    <span class="n">S</span><span class="o">-</span><span class="n">B</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>              <span class="mf">5.564</span> <span class="mf">6.146</span> <span class="mf">6.057</span> <span class="mf">5.805</span> <span class="mf">5.101</span>  <span class="mf">2.633</span>
<span class="mi">2</span>              <span class="mf">4.923</span> <span class="mf">4.948</span> <span class="mf">4.532</span> <span class="mf">5.241</span> <span class="mf">4.778</span>  <span class="mf">2.738</span>
<span class="mi">3</span>              <span class="mf">4.462</span> <span class="mf">4.504</span> <span class="mf">4.023</span> <span class="mf">4.115</span> <span class="mf">3.538</span>  <span class="mf">3.278</span>
<span class="mi">4</span>              <span class="mf">3.569</span> <span class="mf">3.490</span> <span class="mf">3.192</span> <span class="mf">3.348</span> <span class="mf">3.298</span>  <span class="mf">2.411</span>
<span class="n">L</span>              <span class="mf">1.012</span> <span class="mf">1.491</span> <span class="mf">1.540</span> <span class="mf">1.707</span> <span class="mf">1.394</span> <span class="o">-</span><span class="mf">0.111</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>            <span class="mf">6.516</span> <span class="mf">5.822</span> <span class="mf">5.286</span> <span class="mf">4.877</span> <span class="mf">3.885</span>  <span class="mf">2.873</span>
</pre></div>
</div>
</section>
<section id="firm-level-cross-sectional-regression">
<h3>Firm-level cross-sectional regression<a class="headerlink" href="#firm-level-cross-sectional-regression" title="Link to this heading"></a></h3>
<p>References: <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.analytics.crosssectional_regression" title="pyanomaly.analytics.crosssectional_regression"><code class="xref py py-func docutils literal notranslate"><span class="pre">crosssectional_regression()</span></code></a></p>
<ul class="simple">
<li><p>Cross-sectionally regress return at t on t-1 momentum and size.</p></li>
<li><p>Take the time-series average of the coefficients and examine their significance.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;CS regression start.&#39;</span><span class="p">)</span>

<span class="n">y_col</span> <span class="o">=</span> <span class="n">ret_col</span>
<span class="n">X_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">char</span><span class="p">,</span> <span class="n">char2</span><span class="p">]</span>

<span class="c1"># Run the regressions. Output: mean coefficients, t-values, and coefficient time-series.</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">tval</span><span class="p">,</span> <span class="n">coef</span> <span class="o">=</span> <span class="n">crosssectional_regression</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">X_cols</span><span class="p">,</span> <span class="n">add_constant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span>
                                            <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxlags&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mean of the coefficients&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">tval</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Coefficients time-series&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;CS regression end.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mean</span> <span class="n">of</span> <span class="n">the</span> <span class="n">coefficients</span>
           <span class="n">mean</span>  <span class="n">t</span><span class="o">-</span><span class="n">stat</span>
<span class="n">const</span>     <span class="mf">0.006</span>   <span class="mf">3.273</span>
<span class="n">ret_12_1</span>  <span class="mf">0.008</span>   <span class="mf">4.742</span>
<span class="n">me</span>       <span class="o">-</span><span class="mf">0.000</span>  <span class="o">-</span><span class="mf">1.627</span>

<span class="n">Coefficients</span> <span class="n">time</span><span class="o">-</span><span class="n">series</span>
            <span class="n">const</span>  <span class="n">ret_12_1</span>     <span class="n">me</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.012</span>     <span class="mf">0.009</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mf">0.059</span>    <span class="o">-</span><span class="mf">0.011</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="o">-</span><span class="mf">0.029</span>     <span class="mf">0.055</span>  <span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="o">-</span><span class="mf">0.012</span>     <span class="mf">0.050</span>  <span class="mf">0.000</span>
           <span class="o">...</span>       <span class="o">...</span>    <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span> <span class="o">-</span><span class="mf">0.063</span>     <span class="mf">0.005</span>  <span class="mf">0.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span> <span class="o">-</span><span class="mf">0.072</span>     <span class="mf">0.004</span>  <span class="mf">0.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mf">0.090</span>     <span class="mf">0.018</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.105</span>     <span class="mf">0.000</span> <span class="o">-</span><span class="mf">0.000</span>
</pre></div>
</div>
</section>
<section id="factor-regression">
<h3>Factor regression<a class="headerlink" href="#factor-regression" title="Link to this heading"></a></h3>
<p>Regress quantile portfolios’ returns on the FF-3 factors.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;Factor regression start.&#39;</span><span class="p">)</span>

<span class="c1"># Sample period.</span>
<span class="n">sdate</span> <span class="o">=</span> <span class="s1">&#39;1952-01&#39;</span>
<span class="n">edate</span> <span class="o">=</span> <span class="s1">&#39;2020-12&#39;</span>

<span class="n">qpfs</span> <span class="o">=</span> <span class="n">qpfs</span><span class="p">[</span><span class="n">sdate</span><span class="p">:</span><span class="n">edate</span><span class="p">]</span>

<span class="c1"># Read factors.</span>
<span class="c1"># Here, I use the factors generated by PyAnomaly. You can use different sources if you like.</span>
<span class="n">factors</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">factors_monthly_fname</span><span class="p">)</span>
<span class="c1"># factors = WRDS.read_data(&#39;factors_monthly&#39;)  # factors from K.French website.</span>

<span class="c1"># X: Constant + FF3.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sdate</span><span class="p">:</span><span class="n">edate</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mktrf&#39;</span><span class="p">,</span> <span class="s1">&#39;smb_ff&#39;</span><span class="p">,</span> <span class="s1">&#39;hml&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># X = factors.loc[sdate:edate, [&#39;mktrf&#39;, &#39;smb&#39;, &#39;hml&#39;]].values  # If you use K. French data.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Run the regression for each portfolio.</span>
<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
    <span class="c1"># y: Returns of a quantile portfolio</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">qpfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">pf</span><span class="p">),</span> <span class="n">ret_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="c1"># Make an output table.</span>
    <span class="n">result</span><span class="p">[</span><span class="n">pf</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;coefs&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s1">&#39;tval&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;mktrf&#39;</span><span class="p">,</span> <span class="s1">&#39;smb&#39;</span><span class="p">,</span> <span class="s1">&#39;hml&#39;</span><span class="p">])</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Factor regression: FF3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;Factor regression end.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Factor</span> <span class="n">regression</span><span class="p">:</span> <span class="n">FF3</span>
           <span class="n">H</span>              <span class="mi">2</span>             <span class="mi">3</span>             <span class="mi">4</span>             <span class="n">L</span>           <span class="n">H</span><span class="o">-</span><span class="n">L</span>
       <span class="n">coefs</span>    <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>    <span class="n">tval</span>
<span class="n">const</span>  <span class="mf">0.005</span>   <span class="mf">6.662</span>  <span class="mf">0.002</span>  <span class="mf">3.585</span>  <span class="mf">0.000</span>  <span class="mf">0.258</span> <span class="o">-</span><span class="mf">0.002</span> <span class="o">-</span><span class="mf">3.292</span> <span class="o">-</span><span class="mf">0.007</span> <span class="o">-</span><span class="mf">7.505</span>  <span class="mf">0.011</span>   <span class="mf">8.052</span>
<span class="n">mktrf</span>  <span class="mf">1.013</span>  <span class="mf">58.519</span>  <span class="mf">0.956</span> <span class="mf">85.346</span>  <span class="mf">0.941</span> <span class="mf">93.837</span>  <span class="mf">1.000</span> <span class="mf">83.939</span>  <span class="mf">1.220</span> <span class="mf">58.471</span> <span class="o">-</span><span class="mf">0.207</span>  <span class="o">-</span><span class="mf">6.128</span>
<span class="n">smb</span>    <span class="mf">0.191</span>   <span class="mf">7.170</span> <span class="o">-</span><span class="mf">0.116</span> <span class="o">-</span><span class="mf">6.736</span> <span class="o">-</span><span class="mf">0.098</span> <span class="o">-</span><span class="mf">6.386</span> <span class="o">-</span><span class="mf">0.043</span> <span class="o">-</span><span class="mf">2.377</span>  <span class="mf">0.233</span>  <span class="mf">7.265</span> <span class="o">-</span><span class="mf">0.042</span>  <span class="o">-</span><span class="mf">0.813</span>
<span class="n">hml</span>   <span class="o">-</span><span class="mf">0.494</span> <span class="o">-</span><span class="mf">23.610</span> <span class="o">-</span><span class="mf">0.116</span> <span class="o">-</span><span class="mf">8.538</span>  <span class="mf">0.082</span>  <span class="mf">6.757</span>  <span class="mf">0.294</span> <span class="mf">20.425</span>  <span class="mf">0.568</span> <span class="mf">22.526</span> <span class="o">-</span><span class="mf">1.062</span> <span class="o">-</span><span class="mf">26.020</span>
</pre></div>
</div>
</section>
</section>
<section id="module-examples.example3">
<span id="example-3-quantile-portfolio-construction-and-evaluation"></span><h2>Example 3. Quantile portfolio construction and evaluation<a class="headerlink" href="#module-examples.example3" title="Link to this heading"></a></h2>
<p>Quantile portfolio construction and evaluation.</p>
<p>This example demonstrates how to construct quantile portfolios (and the long-short) based on a firm characteristic
and evaluate their performance.</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>Tercile portfolios will be generated from the 12-month momentum.</p></li>
<li><p>Different ways of setting the transaction cost will be demonstrated.</p></li>
</ol>
</div></blockquote>
<ul class="simple">
<li><p>It is assumed that the firm characteristic has been created and saved to config.output_dir + ‘crspm’.</p></li>
</ul>
<p>Processing time: approx. 10 seconds.</p>
<section id="id4">
<h3>Initialization<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<p>Import packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">pyanomaly.globals</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyanomaly.fileio</span> <span class="kn">import</span> <span class="n">read_from_file</span>
<span class="kn">from</span> <span class="nn">pyanomaly.tcost</span> <span class="kn">import</span> <span class="n">TransactionCost</span><span class="p">,</span> <span class="n">TimeVaryingCost</span>
<span class="kn">from</span> <span class="nn">pyanomaly.analytics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyanomaly.wrdsdata</span> <span class="kn">import</span> <span class="n">WRDS</span>
</pre></div>
</div>
<p>Set log file path and start a timer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">set_log_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;Example 3&#39;</span><span class="p">)</span>

<span class="c1"># Jitted functions are slow when first called due to compile time. This example runs faster by disabling jit.</span>
<span class="n">set_config</span><span class="p">(</span><span class="n">disable_jit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>Set variables<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;ret_12_1&#39;</span>  <span class="c1"># 12-month momentum</span>
<span class="n">char_class</span> <span class="o">=</span> <span class="n">char</span> <span class="o">+</span> <span class="s1">&#39;_class&#39;</span>  <span class="c1"># Momentum class column</span>
<span class="n">ret_col</span> <span class="o">=</span> <span class="s1">&#39;exret&#39;</span>  <span class="c1"># Return column</span>
<span class="n">weight_col</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span>  <span class="c1"># Market equity column</span>
<span class="n">split</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Tercile. You can also do split = [0.3, 0.7] for 3:4:3 split.</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]</span>  <span class="c1"># Portfolio names: &#39;H-L&#39; for long short.</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>Load and prepare data<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read crspm data (not raw data but the output data).</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="s1">&#39;crspm&#39;</span><span class="p">)</span>

<span class="c1"># NYSE me</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">exchcd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">weight_col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Delete unnecessary columns to save memory (optional).</span>
<span class="n">keep_columns</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">char</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">,</span> <span class="s1">&#39;nyse_me&#39;</span><span class="p">])</span>

<span class="c1"># Shift data except for return so that all the variables at t are as of t-1 and the return is over t-1 to t.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">shift</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">excl_cols</span><span class="o">=</span><span class="p">[</span><span class="n">ret_col</span><span class="p">])</span>

<span class="c1"># Risk-free rates.</span>
<span class="c1"># Set `month_end=True` since the crspm date has also been shifted to month end.</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">WRDS</span><span class="o">.</span><span class="n">get_risk_free_rate</span><span class="p">(</span><span class="n">month_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="transaction-costs">
<h3>Transaction costs<a class="headerlink" href="#transaction-costs" title="Link to this heading"></a></h3>
<p>PyAnomaly provides a powerful way to set transaction costs via <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.tcost.TransactionCost" title="pyanomaly.tcost.TransactionCost"><code class="xref py py-class docutils literal notranslate"><span class="pre">TransactionCost</span></code></a> and <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.tcost.TimeVaryingCost" title="pyanomaly.tcost.TimeVaryingCost"><code class="xref py py-class docutils literal notranslate"><span class="pre">TimeVaryingCost</span></code></a>
classes. Below are some examples of setting transaction costs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># No transaction costs.</span>
<span class="n">costfcn</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Transaction cost of 30 basis points.</span>
<span class="n">costfcn</span> <span class="o">=</span> <span class="mf">0.003</span>

<span class="c1"># 20 (30) bps when buying (selling).</span>
<span class="n">costfcn</span> <span class="o">=</span> <span class="n">TransactionCost</span><span class="p">(</span><span class="n">buy_linear</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">sell_linear</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, we assume transaction cost varies over time and with size, following Brandt et al. (2009).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">costfcn</span> <span class="o">=</span> <span class="n">TimeVaryingCost</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">weight_col</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="make-tercile-portfolios">
<h3>Make tercile portfolios<a class="headerlink" href="#make-tercile-portfolios" title="Link to this heading"></a></h3>
<p>In PyAnomaly, <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.portfolio.Portfolio" title="pyanomaly.portfolio.Portfolio"><code class="xref py py-class docutils literal notranslate"><span class="pre">Portfolio</span></code></a> class is used to make a portfolio and <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.portfolio.Portfolios" title="pyanomaly.portfolio.Portfolios"><code class="xref py py-class docutils literal notranslate"><span class="pre">Portfolios</span></code></a> class is used to
handle a group of portfolios. <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.analytics.make_quantile_portfolios" title="pyanomaly.analytics.make_quantile_portfolios"><code class="xref py py-func docutils literal notranslate"><span class="pre">make_quantile_portfolios()</span></code></a> uses these classes to construct quantile portfolios.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Exclude bottom 20% based on NYSE size. This should come after setting the time varying cost</span>
<span class="c1"># because `TimeVaryingCost` requires all firms&#39; me as the input.</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">,</span> <span class="n">ginfo</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1"># Classify data on char. The highest momentum stock will be labeled 0 and the lowest 2.</span>
<span class="n">data</span><span class="p">[</span><span class="n">char_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">char</span><span class="p">],</span> <span class="n">split</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ginfo</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="n">portfolios</span> <span class="o">=</span> <span class="n">make_quantile_portfolios</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span> <span class="n">costfcn</span><span class="o">=</span><span class="n">costfcn</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="evaluate-the-portfolios">
<h3>Evaluate the portfolios<a class="headerlink" href="#evaluate-the-portfolios" title="Link to this heading"></a></h3>
<p>Portfolios can be evaluated using <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.portfolio.Portfolio.eval" title="pyanomaly.portfolio.Portfolio.eval"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Portfolio.eval()</span></code></a> for a single portfolio or <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.portfolio.Portfolios.eval" title="pyanomaly.portfolio.Portfolios.eval"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Portfolios.eval()</span></code></a> for a
group of portfolios.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># `annualize_factor=12` will annualize the results as crspm is monthly data.</span>
<span class="n">pfperfs</span><span class="p">,</span> <span class="n">pfvals</span> <span class="o">=</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">annualize_factor</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Performance metrics.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performance&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pfperfs</span><span class="p">)</span>

<span class="c1"># Time-series of portfolio value, return, ...</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Values&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pfvals</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performance</span>
                    <span class="n">H</span>           <span class="n">M</span>           <span class="n">L</span>         <span class="n">H</span><span class="o">-</span><span class="n">L</span>
<span class="n">mean</span>           <span class="o">-</span><span class="mf">0.006</span>      <span class="o">-</span><span class="mf">0.080</span>      <span class="o">-</span><span class="mf">0.079</span>      <span class="o">-</span><span class="mf">0.135</span>
<span class="n">std</span>             <span class="mf">0.195</span>       <span class="mf">0.191</span>       <span class="mf">0.247</span>       <span class="mf">0.167</span>
<span class="n">sharpe</span>         <span class="o">-</span><span class="mf">0.029</span>      <span class="o">-</span><span class="mf">0.419</span>      <span class="o">-</span><span class="mf">0.319</span>      <span class="o">-</span><span class="mf">0.809</span>
<span class="n">cum</span>             <span class="mf">0.692</span>      <span class="o">-</span><span class="mf">6.404</span>      <span class="o">-</span><span class="mf">7.451</span>     <span class="o">-</span><span class="mf">14.777</span>
<span class="n">mdd</span>             <span class="mf">0.877</span>       <span class="mf">1.000</span>       <span class="mf">1.000</span>       <span class="mf">1.000</span>
<span class="n">mdd</span> <span class="n">start</span>  <span class="mi">1929</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1929</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1928</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>
<span class="n">mdd</span> <span class="n">end</span>    <span class="mi">1984</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>
<span class="n">msd</span>             <span class="mf">0.509</span>       <span class="mf">0.557</span>       <span class="mf">0.618</span>       <span class="mf">0.783</span>
<span class="n">msd</span> <span class="n">start</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1973</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>
<span class="n">msd</span> <span class="n">end</span>    <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">1974</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>
<span class="n">turnover</span>        <span class="mf">5.592</span>       <span class="mf">7.716</span>       <span class="mf">6.272</span>      <span class="mf">12.238</span>
<span class="n">lposition</span>     <span class="mf">472.351</span>     <span class="mf">471.740</span>     <span class="mf">472.158</span>     <span class="mf">472.351</span>
<span class="n">sposition</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>     <span class="mf">472.158</span>

<span class="n">Values</span>
           <span class="n">grossret</span> <span class="n">grossexret</span>      <span class="n">val1</span>       <span class="n">val</span> <span class="n">lposition</span> <span class="n">sposition</span>   <span class="n">cost</span> <span class="n">tover</span> <span class="o">...</span>
                  <span class="n">H</span>          <span class="n">H</span>         <span class="n">H</span>         <span class="n">H</span>         <span class="n">H</span>         <span class="n">H</span>      <span class="n">H</span>     <span class="n">H</span> <span class="o">...</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.002</span>     <span class="o">-</span><span class="mf">0.004</span>     <span class="mf">0.998</span>     <span class="mf">1.000</span>       <span class="mi">121</span>     <span class="mf">0.000</span>  <span class="mf">0.000</span> <span class="mf">0.000</span> <span class="o">...</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>    <span class="mf">0.046</span>      <span class="mf">0.044</span>     <span class="mf">1.044</span>     <span class="mf">0.998</span>       <span class="mi">123</span>     <span class="mf">0.000</span>  <span class="mf">0.009</span> <span class="mf">0.415</span> <span class="o">...</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.019</span>      <span class="mf">0.016</span>     <span class="mf">1.065</span>     <span class="mf">1.044</span>       <span class="mi">123</span>     <span class="mf">0.000</span>  <span class="mf">0.016</span> <span class="mf">0.720</span> <span class="o">...</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.019</span>      <span class="mf">0.017</span>     <span class="mf">1.085</span>     <span class="mf">1.065</span>       <span class="mi">127</span>     <span class="mf">0.000</span>  <span class="mf">0.013</span> <span class="mf">0.535</span> <span class="o">...</span>
             <span class="o">...</span>        <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>    <span class="o">...</span>   <span class="o">...</span>    <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>   <span class="o">-</span><span class="mf">0.062</span>     <span class="o">-</span><span class="mf">0.066</span>  <span class="mf">9274.546</span>  <span class="mf">9884.677</span>       <span class="mi">786</span>     <span class="mf">0.000</span> <span class="mf">15.306</span> <span class="mf">0.265</span> <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.025</span>     <span class="o">-</span><span class="mf">0.030</span>  <span class="mf">9039.294</span>  <span class="mf">9274.546</span>       <span class="mi">771</span>     <span class="mf">0.000</span> <span class="mf">20.416</span> <span class="mf">0.393</span> <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.109</span>      <span class="mf">0.104</span> <span class="mf">10023.511</span>  <span class="mf">9039.294</span>       <span class="mi">759</span>     <span class="mf">0.000</span> <span class="mf">17.488</span> <span class="mf">0.401</span> <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.035</span>      <span class="mf">0.031</span> <span class="mf">10378.316</span> <span class="mf">10023.511</span>       <span class="mi">749</span>     <span class="mf">0.000</span> <span class="mf">23.490</span> <span class="mf">0.462</span> <span class="o">...</span>
</pre></div>
</div>
<p>Plot cumulative returns.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot cumulative returns.</span>
<span class="n">pfvals</span><span class="p">[</span><span class="s1">&#39;cumret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot selected portfolios&#39; cumulative returns.</span>
<span class="n">pfvals</span><span class="p">[</span><span class="s1">&#39;cumret&#39;</span><span class="p">][[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example3_plot1.png"><img alt="_images/example3_plot1.png" class="align-center" src="_images/example3_plot1.png" style="width: 500px;" /></a>
<a class="reference internal image-reference" href="_images/example3_plot2.png"><img alt="_images/example3_plot2.png" class="align-center" src="_images/example3_plot2.png" style="width: 500px;" /></a>
<p>Evaluate the portfolios for a sub-period and ignoring transaction costs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pfperfs1</span><span class="p">,</span> <span class="n">pfvals1</span> <span class="o">=</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">sdate</span><span class="o">=</span><span class="s1">&#39;2001-01-01&#39;</span><span class="p">,</span> <span class="n">edate</span><span class="o">=</span><span class="s1">&#39;2010-12-31&#39;</span><span class="p">,</span> <span class="n">annualize_factor</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                    <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;gross&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performance: 2001-01 - 2010-12&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pfperfs1</span><span class="p">)</span>

<span class="c1"># Plot cumulative returns.</span>
<span class="n">pfvals1</span><span class="p">[</span><span class="s1">&#39;cumret&#39;</span><span class="p">][[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performance</span><span class="p">:</span> <span class="mi">2001</span><span class="o">-</span><span class="mi">01</span> <span class="o">-</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">12</span>
                    <span class="n">H</span>           <span class="n">M</span>           <span class="n">L</span>         <span class="n">H</span><span class="o">-</span><span class="n">L</span>
<span class="n">mean</span>            <span class="mf">0.026</span>      <span class="o">-</span><span class="mf">0.001</span>      <span class="o">-</span><span class="mf">0.001</span>       <span class="mf">0.027</span>
<span class="n">std</span>             <span class="mf">0.169</span>       <span class="mf">0.149</span>       <span class="mf">0.256</span>       <span class="mf">0.200</span>
<span class="n">sharpe</span>          <span class="mf">0.152</span>      <span class="o">-</span><span class="mf">0.005</span>      <span class="o">-</span><span class="mf">0.005</span>       <span class="mf">0.134</span>
<span class="n">cum</span>             <span class="mf">0.325</span>       <span class="mf">0.093</span>      <span class="o">-</span><span class="mf">0.126</span>       <span class="mf">0.057</span>
<span class="n">mdd</span>             <span class="mf">0.518</span>       <span class="mf">0.462</span>       <span class="mf">0.689</span>       <span class="mf">0.450</span>
<span class="n">mdd</span> <span class="n">start</span>  <span class="mi">2007</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2007</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>
<span class="n">mdd</span> <span class="n">end</span>    <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>
<span class="n">msd</span>             <span class="mf">0.402</span>       <span class="mf">0.259</span>       <span class="mf">0.404</span>       <span class="mf">0.396</span>
<span class="n">msd</span> <span class="n">start</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>
<span class="n">msd</span> <span class="n">end</span>    <span class="mi">2008</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>
<span class="n">turnover</span>        <span class="mf">6.289</span>       <span class="mf">7.606</span>       <span class="mf">6.150</span>      <span class="mf">12.898</span>
<span class="n">lposition</span>     <span class="mf">677.483</span>     <span class="mf">676.883</span>     <span class="mf">677.208</span>     <span class="mf">677.483</span>
<span class="n">sposition</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>     <span class="mf">677.208</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example3_plot3.png"><img alt="_images/example3_plot3.png" class="align-center" src="_images/example3_plot3.png" style="width: 500px;" /></a>
<p>Access a member portfolio.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># To access portfolio &#39;H&#39;</span>
<span class="n">pf_h</span> <span class="o">=</span> <span class="n">portfolios</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span>

<span class="c1"># You can also access the returns of `eval()` as follows.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performance: H&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pf_h</span><span class="o">.</span><span class="n">performance</span><span class="p">)</span>  <span class="c1"># pf_h_perf</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Values: H&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pf_h</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># pf_h_val</span>

<span class="c1"># To see the positions (constituents)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Positions: H&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pf_h</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;End of Example 6.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performance</span><span class="p">:</span> <span class="n">H</span>
                    <span class="n">H</span>
<span class="n">mean</span>            <span class="mf">0.026</span>
<span class="n">std</span>             <span class="mf">0.169</span>
<span class="n">sharpe</span>          <span class="mf">0.152</span>
<span class="n">cum</span>             <span class="mf">0.325</span>
<span class="n">mdd</span>             <span class="mf">0.518</span>
<span class="n">mdd</span> <span class="n">start</span>  <span class="mi">2007</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>
<span class="n">mdd</span> <span class="n">end</span>    <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>
<span class="n">msd</span>             <span class="mf">0.402</span>
<span class="n">msd</span> <span class="n">start</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>
<span class="n">msd</span> <span class="n">end</span>    <span class="mi">2008</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>
<span class="n">turnover</span>        <span class="mf">6.289</span>
<span class="n">lposition</span>     <span class="mf">677.483</span>
<span class="n">sposition</span>       <span class="mf">0.000</span>

<span class="n">Values</span><span class="p">:</span> <span class="n">H</span>
            <span class="n">grossret</span>  <span class="n">grossexret</span>      <span class="n">val1</span>       <span class="n">val</span>  <span class="n">lposition</span>  <span class="n">sposition</span>   <span class="n">cost</span>  <span class="n">tover</span>  <span class="n">netret</span>  <span class="n">netexret</span>  <span class="n">cumret</span>  <span class="n">drawdown</span>  <span class="n">drawdur</span> <span class="n">drawstart</span>  <span class="n">succdown</span>  <span class="n">succdur</span> <span class="n">succstart</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>    <span class="o">-</span><span class="mf">0.002</span>      <span class="o">-</span><span class="mf">0.004</span>     <span class="mf">0.998</span>     <span class="mf">1.000</span>        <span class="mi">121</span>      <span class="mf">0.000</span>  <span class="mf">0.000</span>  <span class="mf">0.000</span>  <span class="o">-</span><span class="mf">0.002</span>    <span class="o">-</span><span class="mf">0.004</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>     <span class="mf">0.046</span>       <span class="mf">0.044</span>     <span class="mf">1.044</span>     <span class="mf">0.998</span>        <span class="mi">123</span>      <span class="mf">0.000</span>  <span class="mf">0.009</span>  <span class="mf">0.415</span>   <span class="mf">0.037</span>     <span class="mf">0.035</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>     <span class="mf">0.019</span>       <span class="mf">0.016</span>     <span class="mf">1.065</span>     <span class="mf">1.044</span>        <span class="mi">123</span>      <span class="mf">0.000</span>  <span class="mf">0.016</span>  <span class="mf">0.720</span>   <span class="mf">0.004</span>     <span class="mf">0.002</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>     <span class="mf">0.019</span>       <span class="mf">0.017</span>     <span class="mf">1.085</span>     <span class="mf">1.065</span>        <span class="mi">127</span>      <span class="mf">0.000</span>  <span class="mf">0.013</span>  <span class="mf">0.535</span>   <span class="mf">0.007</span>     <span class="mf">0.005</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>
              <span class="o">...</span>         <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>    <span class="o">...</span>    <span class="o">...</span>     <span class="o">...</span>       <span class="o">...</span>     <span class="o">...</span>       <span class="o">...</span>      <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>      <span class="o">...</span>       <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>    <span class="o">-</span><span class="mf">0.062</span>      <span class="o">-</span><span class="mf">0.066</span>  <span class="mf">9274.546</span>  <span class="mf">9884.677</span>        <span class="mi">786</span>      <span class="mf">0.000</span> <span class="mf">15.306</span>  <span class="mf">0.265</span>  <span class="o">-</span><span class="mf">0.063</span>    <span class="o">-</span><span class="mf">0.068</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>    <span class="o">-</span><span class="mf">0.025</span>      <span class="o">-</span><span class="mf">0.030</span>  <span class="mf">9039.294</span>  <span class="mf">9274.546</span>        <span class="mi">771</span>      <span class="mf">0.000</span> <span class="mf">20.416</span>  <span class="mf">0.393</span>  <span class="o">-</span><span class="mf">0.028</span>    <span class="o">-</span><span class="mf">0.032</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>     <span class="mf">0.109</span>       <span class="mf">0.104</span> <span class="mf">10023.511</span>  <span class="mf">9039.294</span>        <span class="mi">759</span>      <span class="mf">0.000</span> <span class="mf">17.488</span>  <span class="mf">0.401</span>   <span class="mf">0.107</span>     <span class="mf">0.103</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>     <span class="mf">0.035</span>       <span class="mf">0.031</span> <span class="mf">10378.316</span> <span class="mf">10023.511</span>        <span class="mi">749</span>      <span class="mf">0.000</span> <span class="mf">23.490</span>  <span class="mf">0.462</span>   <span class="mf">0.033</span>     <span class="mf">0.029</span>     <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>       <span class="n">NaN</span>      <span class="n">NaN</span>       <span class="n">NaT</span>

<span class="n">Positions</span><span class="p">:</span> <span class="n">H</span>
               <span class="nb">id</span>    <span class="n">ret</span>   <span class="n">wgt</span>    <span class="n">rf</span>  <span class="n">exret</span>     <span class="n">val</span>    <span class="n">val1</span>    <span class="n">val0</span>  <span class="n">cost</span>
<span class="n">date</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">10049</span> <span class="o">-</span><span class="mf">0.030</span> <span class="mf">0.004</span> <span class="mf">0.002</span> <span class="o">-</span><span class="mf">0.032</span>   <span class="mf">0.004</span>   <span class="mf">0.003</span>   <span class="mf">0.004</span> <span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">10102</span> <span class="o">-</span><span class="mf">0.020</span> <span class="mf">0.002</span> <span class="mf">0.002</span> <span class="o">-</span><span class="mf">0.023</span>   <span class="mf">0.002</span>   <span class="mf">0.002</span>   <span class="mf">0.002</span> <span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">10129</span> <span class="o">-</span><span class="mf">0.009</span> <span class="mf">0.003</span> <span class="mf">0.002</span> <span class="o">-</span><span class="mf">0.012</span>   <span class="mf">0.003</span>   <span class="mf">0.003</span>   <span class="mf">0.003</span> <span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">10145</span>  <span class="mf">0.021</span> <span class="mf">0.024</span> <span class="mf">0.002</span>  <span class="mf">0.019</span>   <span class="mf">0.024</span>   <span class="mf">0.024</span>   <span class="mf">0.024</span> <span class="mf">0.000</span>
           <span class="o">...</span>    <span class="o">...</span>   <span class="o">...</span>   <span class="o">...</span>    <span class="o">...</span>     <span class="o">...</span>     <span class="o">...</span>     <span class="o">...</span>   <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">93369</span> <span class="o">-</span><span class="mf">0.005</span> <span class="mf">0.000</span> <span class="mf">0.004</span> <span class="o">-</span><span class="mf">0.009</span>   <span class="mf">1.821</span>   <span class="mf">1.811</span>   <span class="mf">0.000</span> <span class="mf">0.011</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">93374</span>  <span class="mf">0.000</span> <span class="mf">0.000</span> <span class="mf">0.000</span>  <span class="mf">0.000</span>   <span class="mf">0.000</span>   <span class="mf">0.000</span>   <span class="mf">2.853</span> <span class="mf">0.017</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">93427</span>  <span class="mf">0.171</span> <span class="mf">0.000</span> <span class="mf">0.004</span>  <span class="mf">0.167</span>   <span class="mf">2.416</span>   <span class="mf">2.830</span>   <span class="mf">2.728</span> <span class="mf">0.002</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">93429</span> <span class="o">-</span><span class="mf">0.024</span> <span class="mf">0.001</span> <span class="mf">0.004</span> <span class="o">-</span><span class="mf">0.028</span>   <span class="mf">7.898</span>   <span class="mf">7.707</span>   <span class="mf">8.944</span> <span class="mf">0.006</span>
</pre></div>
</div>
</section>
</section>
<section id="module-examples.example4">
<span id="example-4-defining-a-new-characteristic"></span><h2>Example 4. Defining a new characteristic<a class="headerlink" href="#module-examples.example4" title="Link to this heading"></a></h2>
<p>Define a new characteristic</p>
<p>This example demonstrates how to define a new characteristic by inheriting CRSPM.</p>
<p>A new characteristic, ‘excess_ret_change’, will be defined, which is the excess return over the market return
divided by the one-year average excess return (I have no idea if this has any predictive power).</p>
<ul class="simple">
<li><p>It is assumed that data has been downloaded from WRDS.</p></li>
</ul>
<p>Processing time: approx. 18 seconds.</p>
<section id="id7">
<h3>Initialization<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p>Import packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyanomaly.globals</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyanomaly.characteristics</span> <span class="kn">import</span> <span class="n">CRSPM</span>
<span class="kn">from</span> <span class="nn">pyanomaly.analytics</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Set log file path and start a timer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">set_log_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;Example 4&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="define-a-new-characteristic-method">
<h3>Define a new characteristic method<a class="headerlink" href="#define-a-new-characteristic-method" title="Link to this heading"></a></h3>
<p>Inherit <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.characteristics.CRSPM" title="pyanomaly.characteristics.CRSPM"><code class="xref py py-class docutils literal notranslate"><span class="pre">CRSPM</span></code></a> and add a new method <code class="docutils literal notranslate"><span class="pre">c_excess_ret_change()</span></code> that defines the new characteristic.
Method name should be of the form ‘c_[characteristic name]’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyCRSPM</span><span class="p">(</span><span class="n">CRSPM</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">c_excess_ret_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change of excess return over the market return.&quot;&quot;&quot;</span>
        <span class="c1"># Make a short (one-line) docstring for description.</span>
        <span class="c1"># This is displayed when &#39;show_available_chars()&#39; is called.</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># One-year average excess return</span>
        <span class="n">avg_exret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exret</span> <span class="o">-</span> <span class="n">cm</span><span class="o">.</span><span class="n">mktrf</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>

        <span class="c1"># Excess return.</span>
        <span class="n">exret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">exret</span> <span class="o">-</span> <span class="n">cm</span><span class="o">.</span><span class="n">mktrf</span>

        <span class="c1"># Characteristic</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">exret</span> <span class="o">/</span> <span class="n">avg_exret</span>

        <span class="k">return</span> <span class="n">char</span>
</pre></div>
</div>
</section>
<section id="generate-the-firm-characteristic">
<h3>Generate the firm characteristic<a class="headerlink" href="#generate-the-firm-characteristic" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a MyCRSPM instance.</span>
<span class="n">crspm</span> <span class="o">=</span> <span class="n">MyCRSPM</span><span class="p">()</span>

<span class="c1"># Load crspm.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1"># Filter data: shrcd in [10, 11, 12]</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>

<span class="c1"># Fill missing months by populating the data.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># Merge crspm with the monthly factors generated earlier.</span>
<span class="c1"># Need this as excess_ret_change uses the market return.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">merge_with_factors</span><span class="p">()</span>

<span class="c1"># Display the firm characteristics to be generated.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">show_available_chars</span><span class="p">()</span>
</pre></div>
</div>
<p>Notice that excess_ret_change has been added.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">beta_60m</span>             <span class="n">Market</span> <span class="n">beta</span> <span class="p">(</span><span class="n">Org</span><span class="p">,</span> <span class="n">JKP</span><span class="p">)</span><span class="o">.</span> <span class="n">Fama</span> <span class="ow">and</span> <span class="n">MacBeth</span> <span class="p">(</span><span class="mi">1973</span><span class="p">)</span>
<span class="o">...</span>                  <span class="o">...</span>
<span class="n">excess_ret_change</span>    <span class="n">Change</span> <span class="n">of</span> <span class="n">excess</span> <span class="k">return</span> <span class="n">over</span> <span class="n">the</span> <span class="n">market</span> <span class="k">return</span><span class="o">.</span>
<span class="o">...</span>                  <span class="o">...</span>
<span class="n">turn</span>                 <span class="n">Share</span> <span class="n">turnover</span> <span class="p">(</span><span class="n">Org</span><span class="p">,</span> <span class="n">GHZ</span><span class="p">)</span><span class="o">.</span> <span class="n">Datar</span><span class="p">,</span> <span class="n">Naik</span><span class="p">,</span> <span class="ow">and</span> <span class="n">Radcliffe</span> <span class="p">(</span><span class="mi">1998</span><span class="p">)</span>
</pre></div>
</div>
<p>Generate firm characteristics</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate excess_ret_change.</span>
<span class="c1"># Without any argument, all characteristics defined in CRSPM and MyCRSPM will be generated.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">create_chars</span><span class="p">(</span><span class="s1">&#39;excess_ret_change&#39;</span><span class="p">)</span>

<span class="c1"># Some other characteristics defined in CRSPM can also be generated.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">create_chars</span><span class="p">([</span><span class="s1">&#39;ret_12_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ret_1_0&#39;</span><span class="p">])</span>  <span class="c1"># 12M momentum and short-term reversal.</span>

<span class="c1"># Check the result</span>
<span class="nb">print</span><span class="p">(</span><span class="n">crspm</span><span class="p">[[</span><span class="s1">&#39;excess_ret_change&#39;</span><span class="p">,</span> <span class="s1">&#39;ret_12_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ret_1_0&#39;</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">excess_ret_change</span>  <span class="n">ret_12_1</span>  <span class="n">ret_1_0</span>
<span class="n">date</span>       <span class="n">permno</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>   <span class="o">-</span><span class="mf">0.257</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>    <span class="mf">0.365</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>   <span class="o">-</span><span class="mf">0.099</span>
                              <span class="o">...</span>       <span class="o">...</span>      <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span> <span class="mi">93436</span>               <span class="mf">8.384</span>    <span class="o">-</span><span class="mf">0.027</span>   <span class="o">-</span><span class="mf">0.030</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span> <span class="mi">93436</span>             <span class="o">-</span><span class="mf">24.680</span>     <span class="mf">0.100</span>   <span class="o">-</span><span class="mf">0.197</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span> <span class="mi">93436</span>               <span class="mf">3.204</span>     <span class="mf">0.032</span>    <span class="mf">0.195</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">93436</span>              <span class="o">-</span><span class="mf">0.337</span>     <span class="mf">0.949</span>    <span class="mf">0.035</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Postprocessing: delete temporary variables and inspect the generated data.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">22</span> <span class="mi">17</span><span class="p">:</span><span class="mi">53</span><span class="p">]</span> <span class="n">No</span><span class="o">.</span> <span class="n">unique</span> <span class="n">dates</span><span class="p">:</span> <span class="mi">1177</span><span class="p">,</span> <span class="n">Date</span> <span class="nb">range</span><span class="p">:</span> <span class="mi">1925</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">22</span> <span class="mi">17</span><span class="p">:</span><span class="mi">53</span><span class="p">]</span> <span class="n">No</span><span class="o">.</span> <span class="n">unique</span> <span class="n">ids</span><span class="p">:</span> <span class="mi">29055</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">22</span> <span class="mi">17</span><span class="p">:</span><span class="mi">53</span><span class="p">]</span> <span class="n">Nans</span><span class="p">,</span> <span class="n">Infs</span>
                   <span class="n">no</span><span class="o">.</span> <span class="n">nans</span>  <span class="n">percentage</span>  <span class="n">no</span><span class="o">.</span> <span class="n">infs</span>  <span class="n">percentage</span>
<span class="n">excess_ret_change</span>    <span class="mi">471639</span>       <span class="mf">0.116</span>         <span class="mi">0</span>       <span class="mf">0.000</span>
<span class="n">ret_12_1</span>             <span class="mi">467584</span>       <span class="mf">0.115</span>         <span class="mi">0</span>       <span class="mf">0.000</span>
<span class="n">ret_1_0</span>              <span class="mi">114462</span>       <span class="mf">0.028</span>         <span class="mi">0</span>       <span class="mf">0.000</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">22</span> <span class="mi">17</span><span class="p">:</span><span class="mi">53</span><span class="p">]</span> <span class="n">Replacing</span> <span class="n">inf</span> <span class="k">with</span> <span class="n">nan</span><span class="o">...</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">22</span> <span class="mi">17</span><span class="p">:</span><span class="mi">53</span><span class="p">]</span> <span class="n">Descriptive</span> <span class="n">statistics</span>
                        <span class="n">count</span>  <span class="n">mean</span>      <span class="n">std</span>          <span class="nb">min</span>     <span class="mf">0.1</span><span class="o">%</span>      <span class="mi">1</span><span class="o">%</span>    <span class="mi">25</span><span class="o">%</span>   <span class="mi">50</span><span class="o">%</span>   <span class="mi">75</span><span class="o">%</span>    <span class="mi">99</span><span class="o">%</span>   <span class="mf">99.9</span><span class="o">%</span>         <span class="nb">max</span>
<span class="n">excess_ret_change</span> <span class="mf">3605208.000</span> <span class="mf">3.712</span> <span class="mf">3781.662</span> <span class="o">-</span><span class="mf">1261260.427</span> <span class="o">-</span><span class="mf">969.774</span> <span class="o">-</span><span class="mf">95.979</span> <span class="o">-</span><span class="mf">1.973</span> <span class="mf">0.945</span> <span class="mf">4.066</span> <span class="mf">98.078</span> <span class="mf">952.120</span> <span class="mf">6076629.096</span>
<span class="n">ret_12_1</span>          <span class="mf">3609263.000</span> <span class="mf">0.135</span>    <span class="mf">0.773</span>       <span class="o">-</span><span class="mf">1.000</span>   <span class="o">-</span><span class="mf">0.956</span>  <span class="o">-</span><span class="mf">0.834</span> <span class="o">-</span><span class="mf">0.208</span> <span class="mf">0.049</span> <span class="mf">0.324</span>  <span class="mf">2.513</span>   <span class="mf">6.902</span>     <span class="mf">436.685</span>
<span class="n">ret_1_0</span>           <span class="mf">3962385.000</span> <span class="mf">0.011</span>    <span class="mf">0.185</span>       <span class="o">-</span><span class="mf">1.000</span>   <span class="o">-</span><span class="mf">0.692</span>  <span class="o">-</span><span class="mf">0.400</span> <span class="o">-</span><span class="mf">0.066</span> <span class="mf">0.000</span> <span class="mf">0.070</span>  <span class="mf">0.579</span>   <span class="mf">1.500</span>      <span class="mf">24.000</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save the data (raw data + firm characteristics) to config.output_dir + &#39;mycrspm&#39;.</span>
<span class="c1"># To save only firm characteristics and a few columns of the raw data, use &#39;other_columns&#39; argument.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># The saved file can be loaded using crspm.load().</span>
<span class="n">crspm</span> <span class="o">=</span> <span class="n">MyCRSPM</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">crspm</span><span class="p">[[</span><span class="s1">&#39;excess_ret_change&#39;</span><span class="p">,</span> <span class="s1">&#39;ret_12_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ret_1_0&#39;</span><span class="p">]])</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;End of Example 4.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">excess_ret_change</span>  <span class="n">ret_12_1</span>  <span class="n">ret_1_0</span>
<span class="n">date</span>       <span class="n">permno</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>      <span class="n">NaN</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>   <span class="o">-</span><span class="mf">0.257</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>    <span class="mf">0.365</span>
<span class="mi">1986</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">10000</span>                 <span class="n">NaN</span>       <span class="n">NaN</span>   <span class="o">-</span><span class="mf">0.099</span>
                              <span class="o">...</span>       <span class="o">...</span>      <span class="o">...</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span> <span class="mi">93436</span>               <span class="mf">8.384</span>    <span class="o">-</span><span class="mf">0.027</span>   <span class="o">-</span><span class="mf">0.030</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span> <span class="mi">93436</span>             <span class="o">-</span><span class="mf">24.680</span>     <span class="mf">0.100</span>   <span class="o">-</span><span class="mf">0.197</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span> <span class="mi">93436</span>               <span class="mf">3.204</span>     <span class="mf">0.032</span>    <span class="mf">0.195</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">93436</span>              <span class="o">-</span><span class="mf">0.337</span>     <span class="mf">0.949</span>    <span class="mf">0.035</span>
</pre></div>
</div>
</section>
</section>
<section id="module-examples.example5">
<span id="example-5-firm-characteristics-using-year-end-me"></span><h2>Example 5. Firm characteristics using year-end ME<a class="headerlink" href="#module-examples.example5" title="Link to this heading"></a></h2>
<p>Firm characteristics using year-end ME</p>
<p>This example demonstrates how to generate funda firm characteristics using year-end ME instead of the latest ME.</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>All firm characteristics defined in FUNDA are generated.</p></li>
<li><p>Only USD-denominated stocks are sampled: currency conversion is unnecessary.</p></li>
<li><p>Only funda is used without merging with fundq: merging the two datasets as in Example 1 is also possible.</p></li>
<li><p>It is assumed that funda data is available 6 months later.</p></li>
</ol>
</div></blockquote>
<ul class="simple">
<li><p>It is assumed that data has been downloaded from WRDS.</p></li>
</ul>
<p>Processing time: approx. 105 seconds.</p>
<section id="id8">
<h3>Initialization<a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<p>Import packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyanomaly.characteristics</span> <span class="kn">import</span> <span class="n">FUNDA</span><span class="p">,</span> <span class="n">CRSPM</span>
<span class="kn">from</span> <span class="nn">pyanomaly.analytics</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Set log file path and start a timer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">set_log_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;Example 5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="market-equity-from-crsp">
<h3>Market equity (from CRSP)<a class="headerlink" href="#market-equity-from-crsp" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load crspm.</span>
<span class="n">crspm</span> <span class="o">=</span> <span class="n">CRSPM</span><span class="p">()</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1"># Filter data: shrcd in [10, 11, 12]</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>

<span class="c1"># Fill missing months by populating the data.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="c1"># &#39;me&#39; and &#39;me_company&#39; (firm-level me) are generated here.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="funda-firm-characteristics">
<h3>FUNDA firm characteristics<a class="headerlink" href="#funda-firm-characteristics" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load funda.</span>
<span class="n">funda</span> <span class="o">=</span> <span class="n">FUNDA</span><span class="p">()</span>
<span class="n">funda</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1"># USD stocks only.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="s1">&#39;curcd&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">))</span>

<span class="c1"># Populate data to monthly.</span>
<span class="c1"># limit=12: Forward fill up to 12 months.</span>
<span class="c1"># lag=6: Shift data 6 months, i.e., data is available 6 months later.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">MONTHLY</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">new_date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># Add year-end market equity to funda.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">add_crsp_me</span><span class="p">(</span><span class="n">crspm</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;year_end&#39;</span><span class="p">)</span>

<span class="c1"># Generate firm characteristics.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">show_available_chars</span><span class="p">()</span>
<span class="n">funda</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="c1"># Postprocess and save results to &#39;./output/funda_yearend_me&#39;.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
<span class="n">funda</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;funda_yearend_me&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="module-examples.example6">
<span id="example-6-playing-with-panel"></span><h2>Example 6. Playing with Panel<a class="headerlink" href="#module-examples.example6" title="Link to this heading"></a></h2>
<p>Playing with Panel</p>
<p>This example demonstrates how to use <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.panel.Panel" title="pyanomaly.panel.Panel"><code class="xref py py-class docutils literal notranslate"><span class="pre">Panel</span></code></a> class.</p>
<p>Import packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyanomaly.panel</span> <span class="kn">import</span> <span class="n">Panel</span>
<span class="kn">from</span> <span class="nn">pyanomaly.analytics</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<section id="monthly-data">
<h3>Monthly data<a class="headerlink" href="#monthly-data" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2023-03-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-04-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-05-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-03-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-04-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-05-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-03-31&#39;</span><span class="p">,</span>
             <span class="s1">&#39;2023-04-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-05-31&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">],</span>
    <span class="s1">&#39;me&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">4700</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">1900</span><span class="p">],</span>
    <span class="s1">&#39;me_nyse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">4700</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">1900</span><span class="p">],</span>
<span class="p">})</span>

<span class="n">data1</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>

<span class="c1"># Instantiate Panel.</span>
<span class="n">panel1</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">MONTHLY</span><span class="p">)</span>
<span class="k">del</span> <span class="n">data1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">panel1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">ret</span>    <span class="n">me</span>  <span class="n">me_nyse</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">0.010</span>   <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>  <span class="mf">0.050</span>   <span class="mi">120</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">0.020</span>   <span class="mi">110</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mf">0.030</span>  <span class="mi">5000</span> <span class="mf">5000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span>  <span class="mf">0.110</span>  <span class="mi">4500</span> <span class="mf">4500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span> <span class="o">-</span><span class="mf">0.030</span>  <span class="mi">4700</span> <span class="mf">4700.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span>    <span class="n">NaN</span>  <span class="mi">2000</span> <span class="mf">2000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">300</span>  <span class="mf">0.030</span>  <span class="mi">2100</span> <span class="mf">2100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span> <span class="o">-</span><span class="mf">0.050</span>  <span class="mi">1900</span> <span class="mf">1900.000</span>
</pre></div>
</div>
<dl class="simple">
<dt>Inspect data. Available options are:</dt><dd><ul class="simple">
<li><p>‘summary’: Data shape, number of unique dates, and number of unique ids.</p></li>
<li><p>‘id_count`: Number of ids per date.</p></li>
<li><p>‘nans’: Number of nans and infs per column.</p></li>
<li><p>‘stats’: Descriptive statistics. Same as <code class="docutils literal notranslate"><span class="pre">data.describe()</span></code>.</p></li>
</ul>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">panel1</span><span class="o">.</span><span class="n">inspect_data</span><span class="p">(</span><span class="n">option</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;id_count&#39;</span><span class="p">,</span> <span class="s1">&#39;nans&#39;</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">23</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">Shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">23</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">No</span><span class="o">.</span> <span class="n">unique</span> <span class="n">dates</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Date</span> <span class="nb">range</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">23</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">No</span><span class="o">.</span> <span class="n">unique</span> <span class="n">ids</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">23</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">No</span><span class="o">.</span> <span class="n">ids</span> <span class="n">per</span> <span class="n">date</span><span class="p">:</span>
 <span class="n">date</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mi">3</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>    <span class="mi">3</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>    <span class="mi">3</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">23</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">Nans</span><span class="p">,</span> <span class="n">Infs</span>
         <span class="n">no</span><span class="o">.</span> <span class="n">nans</span>  <span class="n">percentage</span>  <span class="n">no</span><span class="o">.</span> <span class="n">infs</span>  <span class="n">percentage</span>
<span class="n">ret</span>             <span class="mi">1</span>       <span class="mf">0.111</span>         <span class="mi">0</span>       <span class="mf">0.000</span>
<span class="n">me</span>              <span class="mi">0</span>       <span class="mf">0.000</span>         <span class="mi">0</span>       <span class="mf">0.000</span>
<span class="n">me_nyse</span>         <span class="mi">3</span>       <span class="mf">0.333</span>         <span class="mi">0</span>       <span class="mf">0.000</span>
<span class="p">[</span><span class="mi">2024</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">23</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">Descriptive</span> <span class="n">statistics</span>
         <span class="n">count</span>     <span class="n">mean</span>      <span class="n">std</span>      <span class="nb">min</span>     <span class="mf">0.1</span><span class="o">%</span>       <span class="mi">1</span><span class="o">%</span>      <span class="mi">25</span><span class="o">%</span>      <span class="mi">50</span><span class="o">%</span>      <span class="mi">75</span><span class="o">%</span>      <span class="mi">99</span><span class="o">%</span>    <span class="mf">99.9</span><span class="o">%</span>      <span class="nb">max</span>
<span class="n">ret</span>      <span class="mf">8.000</span>    <span class="mf">0.021</span>    <span class="mf">0.049</span>   <span class="o">-</span><span class="mf">0.050</span>   <span class="o">-</span><span class="mf">0.050</span>   <span class="o">-</span><span class="mf">0.049</span>    <span class="mf">0.000</span>    <span class="mf">0.025</span>    <span class="mf">0.035</span>    <span class="mf">0.106</span>    <span class="mf">0.110</span>    <span class="mf">0.110</span>
<span class="n">me</span>       <span class="mf">9.000</span> <span class="mf">2281.111</span> <span class="mf">2017.588</span>  <span class="mf">100.000</span>  <span class="mf">100.080</span>  <span class="mf">100.800</span>  <span class="mf">120.000</span> <span class="mf">2000.000</span> <span class="mf">4500.000</span> <span class="mf">4976.000</span> <span class="mf">4997.600</span> <span class="mf">5000.000</span>
<span class="n">me_nyse</span>  <span class="mf">6.000</span> <span class="mf">3366.667</span> <span class="mf">1506.873</span> <span class="mf">1900.000</span> <span class="mf">1900.500</span> <span class="mf">1905.000</span> <span class="mf">2025.000</span> <span class="mf">3300.000</span> <span class="mf">4650.000</span> <span class="mf">4985.000</span> <span class="mf">4998.500</span> <span class="mf">5000.000</span>
</pre></div>
</div>
</section>
<section id="quarterly-data">
<h3>Quarterly data<a class="headerlink" href="#quarterly-data" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2023-03-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-06-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-09-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-01-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-04-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-07-31&#39;</span><span class="p">],</span>
    <span class="s1">&#39;prc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">4700</span><span class="p">],</span>
<span class="p">})</span>

<span class="n">data2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>

<span class="c1"># Instantiate Panel.</span>
<span class="n">panel2</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">QUARTERLY</span><span class="p">)</span>
<span class="k">del</span> <span class="n">data2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">panel2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                 <span class="n">prc</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>   <span class="mi">100</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>   <span class="mi">120</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>   <span class="mi">110</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mi">5000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span>  <span class="mi">4500</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mi">4700</span>
</pre></div>
</div>
<p>Populate data to monthly.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">panel2</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">MONTHLY</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">panel2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                 <span class="n">prc</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>   <span class="mi">100</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>   <span class="mi">100</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>   <span class="mi">100</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>   <span class="mi">120</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>   <span class="mi">120</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>   <span class="mi">120</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>   <span class="mi">110</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mi">5000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span> <span class="mi">200</span>  <span class="mi">5000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mi">5000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span>  <span class="mi">4500</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mi">4500</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span>  <span class="mi">4500</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mi">4700</span>
</pre></div>
</div>
</section>
<section id="id-level-operations">
<h3>Id-level operations<a class="headerlink" href="#id-level-operations" title="Link to this heading"></a></h3>
<p>The methods below perform the operation per id and accounting for the data frequency.
For instance, if a data is a quarterly data populated monthly, <code class="docutils literal notranslate"><span class="pre">shift(1)</span></code> will shift the data by 3 (one quarter)
within each id.</p>
<p>Shift panel1.data by one month.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data1_lag1</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data1_lag1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                <span class="n">ret</span>       <span class="n">me</span>  <span class="n">me_nyse</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>   <span class="n">NaN</span>      <span class="n">NaN</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span> <span class="mf">0.010</span>  <span class="mf">100.000</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span> <span class="mf">0.050</span>  <span class="mf">120.000</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>   <span class="n">NaN</span>      <span class="n">NaN</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span> <span class="mf">0.030</span> <span class="mf">5000.000</span> <span class="mf">5000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span> <span class="mf">0.110</span> <span class="mf">4500.000</span> <span class="mf">4500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span>   <span class="n">NaN</span>      <span class="n">NaN</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">300</span>   <span class="n">NaN</span> <span class="mf">2000.000</span> <span class="mf">2000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span> <span class="mf">0.030</span> <span class="mf">2100.000</span> <span class="mf">2100.000</span>
</pre></div>
</div>
<p>Shift panel2.data by one quarter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data2_lag1</span> <span class="o">=</span> <span class="n">panel2</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data2_lag1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                   <span class="n">prc</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>  <span class="mf">100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>  <span class="mf">120.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span> <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span> <span class="mf">5000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span> <span class="mf">5000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span> <span class="mf">5000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span> <span class="mf">4500.000</span>
</pre></div>
</div>
<p>Shift <code class="docutils literal notranslate"><span class="pre">panel1.data['ret']</span></code> by 2 months.
The two lines below are equivalent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ret_lag2</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">panel1</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ret_lag2</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ret_lag2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">date</span>        <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>     <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>     <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>   <span class="mf">0.010</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>     <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">200</span>     <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>   <span class="mf">0.030</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">300</span>     <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">300</span>     <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">300</span>     <span class="n">NaN</span>
</pre></div>
</div>
<p>Quarterly price difference.
The two lines below are equivalent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prc_diff</span> <span class="o">=</span> <span class="n">panel2</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">panel2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">prc_diff</span> <span class="o">=</span> <span class="n">panel2</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prc_diff</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">date</span>        <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>        <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>        <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>        <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>     <span class="mf">20.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>     <span class="mf">20.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>     <span class="mf">20.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>    <span class="o">-</span><span class="mf">10.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>        <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">200</span>        <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>        <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">200</span>   <span class="o">-</span><span class="mf">500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>   <span class="o">-</span><span class="mf">500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">200</span>   <span class="o">-</span><span class="mf">500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>    <span class="mf">200.000</span>
</pre></div>
</div>
<p>Quarterly price percentage change.
The two lines below are equivalent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prc_change</span> <span class="o">=</span> <span class="n">panel2</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">panel2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">prc_change</span> <span class="o">=</span> <span class="n">panel2</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prc_change</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">date</span>        <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>    <span class="mf">0.200</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>    <span class="mf">0.200</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>    <span class="mf">0.200</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>   <span class="o">-</span><span class="mf">0.083</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">200</span>   <span class="o">-</span><span class="mf">0.100</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>   <span class="o">-</span><span class="mf">0.100</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">200</span>   <span class="o">-</span><span class="mf">0.100</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>    <span class="mf">0.044</span>
</pre></div>
</div>
<p>Two-period cumulative returns.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cum_ret</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">cumret</span><span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cum_ret</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">date</span>        <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>    <span class="mf">0.060</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>    <span class="mf">0.071</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">200</span>    <span class="mf">0.143</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>    <span class="mf">0.077</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">300</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">300</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">300</span>   <span class="o">-</span><span class="mf">0.021</span>
</pre></div>
</div>
<p>One-period ahead returns.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fut_ret</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">futret</span><span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fut_ret</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">date</span>        <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>    <span class="mf">0.050</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">100</span>    <span class="mf">0.020</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">100</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>    <span class="mf">0.110</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">200</span>   <span class="o">-</span><span class="mf">0.030</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">200</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">300</span>    <span class="mf">0.030</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">300</span>   <span class="o">-</span><span class="mf">0.050</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">300</span>      <span class="n">NaN</span>
</pre></div>
</div>
<p>Rolling-apply a function to each id.
Supported functions: ‘sum’, ‘mean’, ‘std’, ‘var’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rolling_sum</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">panel1</span><span class="p">[[</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">]],</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">min_n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rolling_sum</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">ret</span>       <span class="n">me</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">0.010</span>  <span class="mf">100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>  <span class="mf">0.060</span>  <span class="mf">220.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">0.070</span>  <span class="mf">230.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mf">0.030</span> <span class="mf">5000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span>  <span class="mf">0.140</span> <span class="mf">9500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mf">0.080</span> <span class="mf">9200.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span>    <span class="n">NaN</span> <span class="mf">2000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">300</span>  <span class="mf">0.030</span> <span class="mf">4100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span> <span class="o">-</span><span class="mf">0.020</span> <span class="mf">4000.000</span>
</pre></div>
</div>
<p>To apply a user-defined function to each id, use <code class="docutils literal notranslate"><span class="pre">apply_to_ids()</span></code>.
Below is the same as the above except that the return value is ndarray.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rolling_sum</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">apply_to_ids</span><span class="p">(</span><span class="n">panel1</span><span class="p">[[</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">]],</span> <span class="n">roll_sum</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rolling_sum</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span> <span class="mf">1.0e-02</span>  <span class="mf">1.0e+02</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">6.0e-02</span>  <span class="mf">2.2e+02</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">7.0e-02</span>  <span class="mf">2.3e+02</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">3.0e-02</span>  <span class="mf">5.0e+03</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">1.4e-01</span>  <span class="mf">9.5e+03</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">8.0e-02</span>  <span class="mf">9.2e+03</span><span class="p">]</span>
 <span class="p">[</span>     <span class="n">nan</span>  <span class="mf">2.0e+03</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">3.0e-02</span>  <span class="mf">4.1e+03</span><span class="p">]</span>
 <span class="p">[</span><span class="o">-</span><span class="mf">2.0e-02</span>  <span class="mf">4.0e+03</span><span class="p">]]</span>
</pre></div>
</div>
</section>
<section id="date-level-operations">
<h3>Date-level operations<a class="headerlink" href="#date-level-operations" title="Link to this heading"></a></h3>
<p>To apply a user-defined function to each date, use <code class="docutils literal notranslate"><span class="pre">apply_to_dates()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Functino to apply: sum of each column.</span>
<span class="k">def</span> <span class="nf">sum0</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">column_sum</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">apply_to_dates</span><span class="p">(</span><span class="n">panel1</span><span class="p">[[</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">]],</span> <span class="n">sum0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">column_sum</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span>      <span class="n">nan</span>  <span class="mf">7.10e+03</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">1.90e-01</span>  <span class="mf">6.72e+03</span><span class="p">]</span>
 <span class="p">[</span><span class="o">-</span><span class="mf">6.00e-02</span>  <span class="mf">6.71e+03</span><span class="p">]]</span>
</pre></div>
</div>
</section>
<section id="rolling-regression">
<h3>Rolling regression<a class="headerlink" href="#rolling-regression" title="Link to this heading"></a></h3>
<p>The first column of the first argument is used as the dependent variable and the rest as the independent variables.
First K (number of independent varialbes) columns of the return are coefficients, the next column is R-squared,
and the last column is idiosyncratic volatility (standard deviation of residuals).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">retval</span> <span class="o">=</span> <span class="n">panel1</span><span class="o">.</span><span class="n">rolling_regression</span><span class="p">(</span><span class="n">panel1</span><span class="p">[[</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">]],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">min_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">add_const</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">retval</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="s1">&#39;Idio vol&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">panel1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                <span class="n">alpha</span>     <span class="n">me</span>    <span class="n">R2</span>  <span class="n">Idio</span> <span class="n">vol</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>    <span class="n">NaN</span>    <span class="n">NaN</span>   <span class="n">NaN</span>       <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span> <span class="o">-</span><span class="mf">0.190</span>  <span class="mf">0.002</span> <span class="mf">1.000</span>     <span class="mf">0.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span> <span class="o">-</span><span class="mf">0.193</span>  <span class="mf">0.002</span> <span class="mf">0.923</span>     <span class="mf">0.006</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>    <span class="n">NaN</span>    <span class="n">NaN</span>   <span class="n">NaN</span>       <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span>  <span class="mf">0.830</span> <span class="o">-</span><span class="mf">0.000</span> <span class="mf">1.000</span>     <span class="mf">0.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mf">0.659</span> <span class="o">-</span><span class="mf">0.000</span> <span class="mf">0.222</span>     <span class="mf">0.062</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span>    <span class="n">NaN</span>    <span class="n">NaN</span>   <span class="n">NaN</span>       <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">300</span>    <span class="n">NaN</span>    <span class="n">NaN</span>   <span class="n">NaN</span>       <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span> <span class="o">-</span><span class="mf">0.810</span>  <span class="mf">0.000</span> <span class="mf">1.000</span>     <span class="mf">0.000</span>
</pre></div>
</div>
</section>
<section id="panel-merge">
<h3>Panel merge<a class="headerlink" href="#panel-merge" title="Link to this heading"></a></h3>
<p>Two panels can be merged as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">panel1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">panel2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">panel1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">ret</span>    <span class="n">me</span>  <span class="n">me_nyse</span>      <span class="n">prc</span>
<span class="n">date</span>       <span class="nb">id</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">0.010</span>   <span class="mi">100</span>      <span class="n">NaN</span>  <span class="mf">100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">100</span>  <span class="mf">0.050</span>   <span class="mi">120</span>      <span class="n">NaN</span>  <span class="mf">100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">100</span>  <span class="mf">0.020</span>   <span class="mi">110</span>      <span class="n">NaN</span>  <span class="mf">100.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span>  <span class="mf">0.030</span>  <span class="mi">5000</span> <span class="mf">5000.000</span> <span class="mf">5000.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">200</span>  <span class="mf">0.110</span>  <span class="mi">4500</span> <span class="mf">4500.000</span> <span class="mf">4500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">200</span> <span class="o">-</span><span class="mf">0.030</span>  <span class="mi">4700</span> <span class="mf">4700.000</span> <span class="mf">4500.000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span>    <span class="n">NaN</span>  <span class="mi">2000</span> <span class="mf">2000.000</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">300</span>  <span class="mf">0.030</span>  <span class="mi">2100</span> <span class="mf">2100.000</span>      <span class="n">NaN</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="mi">300</span> <span class="o">-</span><span class="mf">0.050</span>  <span class="mi">1900</span> <span class="mf">1900.000</span>      <span class="n">NaN</span>
</pre></div>
</div>
</section>
</section>
<section id="module-examples.example7">
<span id="example-7-table-download"></span><h2>Example 7. Table download<a class="headerlink" href="#module-examples.example7" title="Link to this heading"></a></h2>
<p>Table download</p>
<p>This example demonstrates how to download a new table from WRDS.
Different ways of downloading comp.secm table are demonstrated.</p>
<p>The table will be saved to ‘./input/comp/secm’.</p>
<section id="id9">
<h3>Initialization<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<p>Import packages</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyanomaly.globals</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyanomaly.wrdsdata</span> <span class="kn">import</span> <span class="n">WRDS</span>
</pre></div>
</div>
<p>Set log file path and start a timer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">set_log_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;Example 7&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="wrds-instantiation">
<h3>WRDS instantiation<a class="headerlink" href="#wrds-instantiation" title="Link to this heading"></a></h3>
<p>References: <a class="reference internal" href="pyanomaly_edited.html#pyanomaly.wrdsdata.WRDS" title="pyanomaly.wrdsdata.WRDS"><code class="xref py py-class docutils literal notranslate"><span class="pre">WRDS</span></code></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span> <span class="o">=</span> <span class="n">WRDS</span><span class="p">(</span><span class="n">wrds_usename</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="data-download">
<h3>Data download<a class="headerlink" href="#data-download" title="Link to this heading"></a></h3>
<p>Method 1: Download the entire table at once.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span><span class="o">.</span><span class="n">download_table</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span>  <span class="c1"># &#39;datadate&#39;s type will be converted to datetime.</span>
</pre></div>
</div>
<p>Method 2: Download the entire table asynchronously.</p>
<p>Download data every <cite>interval</cite> years. For a small size data, this can be slower than <code class="docutils literal notranslate"><span class="pre">download_table()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span><span class="o">.</span><span class="n">download_table_async</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Method 3: Download only some fields.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;datadate, gvkey, cshoq, prccm&#39;</span>  <span class="c1"># fields to select</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">download_table_async</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Method 4: Download data using a complete query statement.</p>
<p>Below is equivalent to the above.
Note that the query statement must contain ‘WHERE [<cite>date_col</cite>] BETWEEN {} and {}’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT datadate, gvkey, cshoq, prccm</span>
<span class="s2">    FROM comp.secm</span>
<span class="s2">    WHERE datadate between &#39;</span><span class="se">{{}}</span><span class="s2">&#39; and &#39;</span><span class="se">{{}}</span><span class="s2">&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">download_table_async</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="building_your_own.html" class="btn btn-neutral float-right" title="Bulding Your Own" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Chulwoo Han and Jongho Kang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>