<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cookbook &mdash; PyAnomaly 0.9 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="pyanomaly" href="pyanomaly_edited.html" />
    <link rel="prev" title="Installation" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> PyAnomaly
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#main-features">Main Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#coverage">Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#structure">Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#system-requirement">System Requirement</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#comparison-to-other-sources">Comparison to Other Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#useful-links">Useful Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#glossary">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html#featured-in">Featured In</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How to Use</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html#generating-characteristics">Generating Characteristics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example-1">Example 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-2">Example 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-4">Example 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-5">Example 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-6">Example 6</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-7">Example 7</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#bulding-your-own">Bulding Your Own</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#making-your-own-list-of-characteristics">Making your own list of characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-new-characteristic">Adding a new characteristic</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pyanomaly_edited.html">pyanomaly</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PyAnomaly</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Cookbook</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/cookbook.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cookbook">
<h1>Cookbook<a class="headerlink" href="#cookbook" title="Permalink to this headline"></a></h1>
<p>All the examples presented below can be found <a class="reference external" href="https://github.com/chulwoohan/pyanomaly/blob/master/examples.py">here</a>.
For the deatils of each function or class, refer to the API documentation (<a class="reference internal" href="pyanomaly_edited.html#pyanomaly"><span class="std std-ref">pyanomaly</span></a>).</p>
<section id="example-1">
<h2>Example 1<a class="headerlink" href="#example-1" title="Permalink to this headline"></a></h2>
<p><strong>Firm characteristics generation replicating JKP.</strong></p>
<p>This example shows the full process of i) data download, ii) factor creation, and iii) characteristics creation.
This example replicates the JKP’s SAS code as closely as possible.</p>
<p>In this example,</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>funda is merged with fundq to create quarterly updated annual accounting data.</p></li>
<li><p>The latest market equity (me) is used when creating firm characteristics.</p></li>
<li><p>Generate firm characteristics that appear in the JKP’s paper.</p></li>
</ol>
</div></blockquote>
<section id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline"></a></h3>
<p>Set the log file path and initialize time check (can be skipped).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set log file path. Without this, the log will be printed in stdout.</span>
<span class="n">set_log_path</span><span class="p">(</span><span class="s1">&#39;./log/example1.log&#39;</span><span class="p">)</span>
<span class="c1"># initialize time check.</span>
<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;Start of Example 1.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="data-download">
<h3>Data download<a class="headerlink" href="#data-download" title="Permalink to this headline"></a></h3>
<p>Download data frm WRDS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span> <span class="o">=</span> <span class="n">WRDS</span><span class="p">(</span><span class="n">wrds_username</span><span class="p">)</span>  <span class="c1"># Use your WRDS user id.</span>
<span class="c1"># Download all necessary data.</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">download_all</span><span class="p">()</span>
<span class="c1"># Create crspm(d) from m(d)sf and m(d)seall and add gvkey to them.</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">preprocess_crsp</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="factor-generation">
<h3>Factor generation<a class="headerlink" href="#factor-generation" title="Permalink to this headline"></a></h3>
<p>Generate FF3 and HXZ4 factors.
These are used in some firm characteristics, such as the residual momentum.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make_factor_portfolios</span><span class="p">(</span><span class="n">monthly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Monthly factors</span>
<span class="n">make_factor_portfolios</span><span class="p">(</span><span class="n">monthly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Daily factors</span>
</pre></div>
</div>
</section>
<section id="characteristic-generation">
<h3>Characteristic generation<a class="headerlink" href="#characteristic-generation" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate characteristics in &#39;jkp&#39; column in mapping.xlsx.</span>
<span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;jkp&#39;</span>
<span class="c1"># Start date. Set to None to create characteristics from as early as possible.</span>
<span class="n">sdate</span> <span class="o">=</span> <span class="s1">&#39;1950-01-01&#39;</span>

<span class="c1">###################################</span>
<span class="c1"># CRSPM</span>
<span class="c1">###################################</span>
<span class="c1"># Generate firm characteristics from crspm.</span>

<span class="n">crspm</span> <span class="o">=</span> <span class="n">CRSPM</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
<span class="c1"># Load crspm.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># Filter data on shrcd, ...</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
<span class="c1"># Fill missing months by populating the data.</span>
<span class="c1"># There are only few missing data and the results aren&#39;t affected much by this.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">MONTHLY</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>
<span class="c1"># Merge crspm with the factors created earlier.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">merge_with_factors</span><span class="p">()</span>

<span class="c1"># Display what characteristics will be generated. Just for information.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">show_available_functions</span><span class="p">()</span>
<span class="c1"># Create characteristics.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="c1"># Postprocessing: delete temporary variables, etc.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
<span class="c1"># Saves the results. You can give a file name if you wish. Otherwise, the file name will be the lower-case class</span>
<span class="c1"># name, i.e., crspm. The file can later be loaded using the method, crspm.load().</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1">###################################</span>
<span class="c1"># CRSPD</span>
<span class="c1">###################################</span>
<span class="c1"># Generate firm characteristics from crspd.</span>

<span class="n">crspd</span> <span class="o">=</span> <span class="n">CRSPD</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
<span class="c1"># Load crspd.</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># Filter data on shrcd, ...</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">merge_with_factors</span><span class="p">()</span>

<span class="n">crspd</span><span class="o">.</span><span class="n">show_available_functions</span><span class="p">()</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="n">crspd</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
<span class="n">crspd</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1">###################################</span>
<span class="c1"># FUNDQ</span>
<span class="c1">###################################</span>
<span class="c1"># Generate firm characteristics from fundq.</span>

<span class="n">fundq</span> <span class="o">=</span> <span class="n">FUNDQ</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
<span class="c1"># Load fundq.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># fundq has some duplicates (same datedate/gvkey). Drop duplicates.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">remove_duplicates</span><span class="p">()</span>
<span class="c1"># Convert values in another currency (currently only CAD) to USD values.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">()</span>
<span class="c1"># Populate data to monthly.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">convert_to_monthly</span><span class="p">()</span>
<span class="c1"># Make quarterly variables from ytd variables and use them to fill missing quarterly variables.</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">create_qitems_from_yitems</span><span class="p">()</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="n">fundq</span><span class="o">.</span><span class="n">show_available_functions</span><span class="p">()</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="n">fundq</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
<span class="n">fundq</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1">###################################</span>
<span class="c1"># FUNDA</span>
<span class="c1">###################################</span>
<span class="c1"># Generate firm characteristics from funda.</span>

<span class="n">funda</span> <span class="o">=</span> <span class="n">FUNDA</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
<span class="c1"># Load fundq.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="n">funda</span><span class="o">.</span><span class="n">convert_currency</span><span class="p">()</span>
<span class="n">funda</span><span class="o">.</span><span class="n">convert_to_monthly</span><span class="p">()</span>
<span class="c1"># Generate quarterly-updated funda data from fundq and merge them with funda.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">merge_with_fundq</span><span class="p">(</span><span class="n">fundq</span><span class="p">)</span>
<span class="n">funda</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>
<span class="c1"># Add the market equity of crspm to funda.</span>
<span class="n">funda</span><span class="o">.</span><span class="n">add_crsp_me</span><span class="p">(</span><span class="n">crspm</span><span class="p">)</span>

<span class="n">funda</span><span class="o">.</span><span class="n">show_available_functions</span><span class="p">()</span>
<span class="n">funda</span><span class="o">.</span><span class="n">create_chars</span><span class="p">()</span>

<span class="n">funda</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
<span class="n">funda</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1">###################################</span>
<span class="c1"># Merge</span>
<span class="c1">###################################</span>
<span class="c1"># Combine everything together and generate firm characteristics that require data from multiple data sources.</span>

<span class="n">merge</span> <span class="o">=</span> <span class="n">Merge</span><span class="p">()</span>
<span class="c1"># Merge all data together.</span>
<span class="n">merge</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">crspm</span><span class="p">,</span> <span class="n">crspd</span><span class="p">,</span> <span class="n">funda</span><span class="p">,</span> <span class="n">fundq</span><span class="p">)</span>

<span class="n">merge</span><span class="o">.</span><span class="n">show_available_functions</span><span class="p">()</span>
<span class="n">merge_chars</span> <span class="o">=</span> <span class="n">merge</span><span class="o">.</span><span class="n">get_available_chars</span><span class="p">()</span>
<span class="n">merge</span><span class="o">.</span><span class="n">create_chars</span><span class="p">(</span><span class="n">merge_chars</span><span class="p">)</span>

<span class="n">merge</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
<span class="c1"># By default, `Panel.save()` saves all the columns of `Panel.data`.</span>
<span class="c1"># If you want to save only the variables you need to save the disc space, you can do, e.g.:</span>
<span class="c1"># columns = [&#39;gvkey&#39;, &#39;datadate&#39;, &#39;primary&#39;, &#39;me&#39;, &#39;ret&#39;, &#39;exret&#39;, &#39;rf&#39;]</span>
<span class="c1"># merge.save(other_columns=columns)</span>
<span class="c1"># Then, all firm characteristics plus the columns in `columns` will be saved.</span>
<span class="n">merge</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;End of Example 1.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="example-2">
<h2>Example 2<a class="headerlink" href="#example-2" title="Permalink to this headline"></a></h2>
<p><strong>Different ways of generating characteristics.</strong></p>
<p>This example demonstrates</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>how to generate a few selected firm characteristics without adding a column to mapping.xlsx;</p></li>
<li><p>how to set the output file path instead of the default path.</p></li>
</ol>
</div></blockquote>
<ul class="simple">
<li><p>It is assumed that data has been downloaded from WRDS.</p></li>
<li><p>Short-term reversal and 12M-momentum will be generated.</p></li>
<li><p><cite>alias</cite> is set to None, which means function names are used as aliases.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;Start of Example 2.&#39;</span><span class="p">)</span>

<span class="n">alias</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># alias = function names</span>
<span class="n">sdate</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># create characteristics from as early as possible.</span>

<span class="c1"># Characteristics to generate: short-term reversal and 12M-momentum.</span>
<span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ret_1_0&#39;</span><span class="p">,</span> <span class="s1">&#39;ret_12_1&#39;</span><span class="p">]</span>

<span class="c1"># Generate firm characteristics from crspm.</span>
<span class="n">crspm</span> <span class="o">=</span> <span class="n">CRSPM</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="c1"># Filter data on shrcd, ...</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
<span class="c1"># Let&#39;s skip populate() to save time as it doesn&#39;t change the result much.</span>
<span class="c1"># crspm.populate(freq=MONTHLY, method=None)</span>

<span class="c1"># Some preprocessing, e.g., creating frequently used variables.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># Give a list of characteristics to generate.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">create_chars</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>

<span class="n">crspm</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>

<span class="c1"># Save the output to ./output2/example2.pickle.</span>
<span class="c1"># `other_columns=[]` will save only the characterisitcs.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;example2&#39;</span><span class="p">,</span> <span class="n">fdir</span><span class="o">=</span><span class="s1">&#39;output2&#39;</span><span class="p">,</span> <span class="n">other_columns</span><span class="o">=</span><span class="p">[])</span>

<span class="n">elapsed_time</span><span class="p">(</span><span class="s1">&#39;End of Example 2.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-4">
<h2>Example 4<a class="headerlink" href="#example-4" title="Permalink to this headline"></a></h2>
<p><strong>Defining a new characteristic.</strong></p>
<p>This example demonstrates how to define a new class by inheriting CRSPM and add a new characteristic.</p>
<p>A new characteristic, ‘excess_ret_change’, will be added, which is defined as the excess return over the market return
divided by the one-year average excess return (I have no idea if this has any predictive power).</p>
<ul class="simple">
<li><p>It is assumed that data has been downloaded from WRDS.</p></li>
</ul>
<section id="defining-a-new-characteristic-function">
<h3>Defining a new characteristic function<a class="headerlink" href="#defining-a-new-characteristic-function" title="Permalink to this headline"></a></h3>
<p>This a new class by inheriting <code class="docutils literal notranslate"><span class="pre">CRSPM</span></code> and add a new function <code class="docutils literal notranslate"><span class="pre">c_excess_ret_change()</span></code> that defines
the new characteristic.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyCRSPM</span><span class="p">(</span><span class="n">CRSPM</span><span class="p">):</span>

    <span class="c1"># Function for the new characteristic.</span>
    <span class="c1"># Note that function name should be of the form &#39;c_[characteristic name]&#39;.</span>
    <span class="k">def</span> <span class="nf">c_excess_ret_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change of excess return over the market return.&quot;&quot;&quot;</span>
        <span class="c1"># Make a short (one-line) docstring for description.</span>
        <span class="c1"># This is displayed when `show_available_functions()` is called.</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># One-year average excess return</span>
        <span class="n">avg_exret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exret</span> <span class="o">-</span> <span class="n">cm</span><span class="o">.</span><span class="n">mktrf</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="c1"># Excess return.</span>
        <span class="n">exret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">exret</span> <span class="o">-</span> <span class="n">cm</span><span class="o">.</span><span class="n">mktrf</span>

        <span class="c1"># Characteristic</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">exret</span> <span class="o">/</span> <span class="n">avg_exret</span>

        <span class="k">return</span> <span class="n">char</span>
</pre></div>
</div>
</section>
<section id="new-characteristic-generation">
<h3>New characteristic generation<a class="headerlink" href="#new-characteristic-generation" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alias</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># alias = function names</span>
<span class="n">sdate</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># create characteristics from as early as possible.</span>

<span class="c1"># Characteristics to generate: the function name is the characteristic name without alias.</span>
<span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;excess_ret_change&#39;</span><span class="p">]</span>

<span class="c1"># Instantiate the class defined above.</span>
<span class="n">crspm</span> <span class="o">=</span> <span class="n">MyCRSPM</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sdate</span><span class="p">)</span>

<span class="n">crspm</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">update_variables</span><span class="p">()</span>

<span class="c1"># We need to add factors as we need the market return.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">merge_with_factors</span><span class="p">()</span>

<span class="c1"># Let&#39;s see if &#39;excess_ret_change&#39; has been added.</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">show_available_functions</span><span class="p">()</span>

<span class="c1"># Let&#39;s create the characteristic!</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">create_chars</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>

<span class="n">crspm</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
<span class="n">crspm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;example4&#39;</span><span class="p">)</span>

<span class="c1"># Later, you can load the saved file using &#39;read_from_data()&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="s1">&#39;example4&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;excess_ret_change&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="example-5">
<h2>Example 5<a class="headerlink" href="#example-5" title="Permalink to this headline"></a></h2>
<p><strong>Sorting-based portfolio analysis.</strong></p>
<p>This example demonstrates how to construct quantile portfolios and carry out 1-D or 2-D sorts.</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>Quintile portfolios will be generated from the 12-month momentum and their mean returns and t-values will be computed.</p></li>
<li><p>5x5 2-D sort will be conducted on momentum and size.</p></li>
<li><p>Firm-level cross-sectional regression will be conducted.</p></li>
<li><p>Factor regressions will be carried out using FF 3-factors.</p></li>
</ol>
</div></blockquote>
<ul class="simple">
<li><p>It is assumed that the firm characteristic has been created and saved to ‘crspm.pickle’.</p></li>
</ul>
<section id="set-variables">
<h3>Set variables<a class="headerlink" href="#set-variables" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;ret_12_1&#39;</span>  <span class="c1"># 12-month momentum</span>
<span class="n">char_class</span> <span class="o">=</span> <span class="n">char</span> <span class="o">+</span> <span class="s1">&#39;_class&#39;</span>  <span class="c1"># Group column: portfolio-stock mapping</span>
<span class="n">ret_col</span> <span class="o">=</span> <span class="s1">&#39;futret&#39;</span>  <span class="c1"># Future return column</span>
<span class="n">weight_col</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span>  <span class="c1"># Market equity column</span>
<span class="n">split</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Qintile. You can also do split = [0.2, 0.4, 0.6, 0.8].</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]</span>  <span class="c1"># Portfolio names: &#39;H-L&#39; for long short.</span>
</pre></div>
</div>
</section>
<section id="load-data">
<h3>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read crspm data (not raw data but the output data).</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="s1">&#39;crspm&#39;</span><span class="p">)</span>

<span class="c1"># If you want to exclude bottom 20% based on NYSE size...</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">exchcd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">weight_col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># NYSE me</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">)</span>

<span class="c1"># Make the future return. If it&#39;s already in the data, this step can be skipped.</span>
<span class="n">data</span><span class="p">[</span><span class="n">ret_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_future_return</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;exret&#39;</span><span class="p">])</span>  <span class="c1"># Excess return</span>

<span class="c1"># Note that the future return at t is the return between t and t+1 and other values are as of t.</span>
<span class="c1"># If you want the return at t to be the return between t-1 and t and all other values as of t-1,</span>
<span class="c1"># you have to shift forward data as follows.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Shift data forward.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">ret_col</span><span class="p">])</span>  <span class="c1"># Drop nan returns.</span>
</pre></div>
</div>
</section>
<section id="d-sort">
<h3>1-D sort<a class="headerlink" href="#d-sort" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Classify stocks based on char.</span>
<span class="n">data</span><span class="p">[</span><span class="n">char_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">char</span><span class="p">],</span> <span class="n">split</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Make quantile portfolios.</span>
<span class="c1"># qpfs will have index = date/classes and columns = [&#39;futret&#39;]</span>
<span class="n">qpfs</span> <span class="o">=</span> <span class="n">one_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="n">weight_col</span><span class="p">)</span>

<span class="c1"># You can add more columns to the portfolios. Here I add `signal` (mean of the characteristic) and</span>
<span class="c1"># n_firms (number of firms).</span>
<span class="n">qpfs</span><span class="p">[[</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;n_firms&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">one_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>

<span class="c1"># If you want to see the average size and price of the portfolios...</span>
<span class="n">qpfs</span><span class="p">[[</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;prc&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">one_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="p">[</span><span class="n">weight_col</span><span class="p">,</span> <span class="s1">&#39;prc&#39;</span><span class="p">])</span>

<span class="c1"># Name the portfolios. Without this, the names are 0, 1, ...</span>
<span class="n">relabel_class</span><span class="p">(</span><span class="n">qpfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quantile portfolios sorted on </span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">qpfs</span><span class="p">)</span>

<span class="c1"># Calculate the time-series mean and t-value of the future return for each portfolio.</span>
<span class="c1"># avg and tval have index values equal to the portfolio names.</span>
<span class="n">avg</span><span class="p">,</span> <span class="n">tval</span> <span class="o">=</span> <span class="n">time_series_average</span><span class="p">(</span><span class="n">qpfs</span><span class="p">[</span><span class="n">ret_col</span><span class="p">],</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxlags&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Mean of portfolio returns sorted on </span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tval</span><span class="p">)</span>
<span class="c1"># Put them together to make a nice table.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">avg</span><span class="p">,</span> <span class="n">tval</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;t-val&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Quantile</span> <span class="n">portfolios</span> <span class="nb">sorted</span> <span class="n">on</span> <span class="n">ret_12_1</span>
                           <span class="n">futret</span>  <span class="n">signal</span>  <span class="n">n_firms</span>      <span class="n">size</span>     <span class="n">prc</span>
<span class="n">date</span>       <span class="n">ret_12_1_class</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="n">H</span>               <span class="o">-</span><span class="mf">0.010</span>   <span class="mf">0.482</span>       <span class="mi">69</span>    <span class="mf">85.210</span>  <span class="mf">73.924</span>
           <span class="mi">2</span>                <span class="mf">0.009</span>   <span class="mf">0.151</span>       <span class="mi">69</span>   <span class="mf">131.678</span>  <span class="mf">89.196</span>
           <span class="mi">3</span>               <span class="o">-</span><span class="mf">0.001</span>   <span class="mf">0.013</span>       <span class="mi">69</span>    <span class="mf">91.500</span>  <span class="mf">83.021</span>
           <span class="mi">4</span>               <span class="o">-</span><span class="mf">0.004</span>  <span class="o">-</span><span class="mf">0.106</span>       <span class="mi">69</span>    <span class="mf">54.869</span>  <span class="mf">54.849</span>
           <span class="n">L</span>               <span class="o">-</span><span class="mf">0.005</span>  <span class="o">-</span><span class="mf">0.329</span>       <span class="mi">69</span>    <span class="mf">25.706</span>  <span class="mf">34.803</span>
           <span class="n">H</span><span class="o">-</span><span class="n">L</span>             <span class="o">-</span><span class="mf">0.005</span>   <span class="mf">0.811</span>        <span class="mi">0</span>    <span class="mf">59.504</span>  <span class="mf">39.120</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span> <span class="n">H</span>                <span class="mf">0.055</span>   <span class="mf">0.442</span>       <span class="mi">71</span>    <span class="mf">97.356</span>  <span class="mf">81.886</span>
           <span class="mi">2</span>                <span class="mf">0.040</span>   <span class="mf">0.151</span>       <span class="mi">70</span>   <span class="mf">130.918</span>  <span class="mf">89.640</span>
           <span class="mi">3</span>                <span class="mf">0.028</span>   <span class="mf">0.048</span>       <span class="mi">71</span>    <span class="mf">77.347</span>  <span class="mf">74.449</span>
           <span class="mi">4</span>                <span class="mf">0.048</span>  <span class="o">-</span><span class="mf">0.074</span>       <span class="mi">70</span>    <span class="mf">55.549</span>  <span class="mf">52.839</span>
           <span class="n">L</span>                <span class="mf">0.067</span>  <span class="o">-</span><span class="mf">0.299</span>       <span class="mi">71</span>    <span class="mf">26.083</span>  <span class="mf">34.153</span>
           <span class="n">H</span><span class="o">-</span><span class="n">L</span>             <span class="o">-</span><span class="mf">0.012</span>   <span class="mf">0.741</span>        <span class="mi">0</span>    <span class="mf">71.273</span>  <span class="mf">47.732</span>
                           <span class="o">...</span>     <span class="o">...</span>      <span class="o">...</span>       <span class="o">...</span>     <span class="o">...</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="n">H</span>                <span class="mf">0.057</span>   <span class="mf">1.188</span>      <span class="mi">442</span> <span class="mf">27538.688</span> <span class="mf">118.659</span>
           <span class="mi">2</span>                <span class="mf">0.024</span>   <span class="mf">0.174</span>      <span class="mi">442</span> <span class="mf">23863.618</span> <span class="mf">115.923</span>
           <span class="mi">3</span>                <span class="mf">0.038</span>  <span class="o">-</span><span class="mf">0.042</span>      <span class="mi">442</span> <span class="mf">20827.442</span> <span class="mf">867.161</span>
           <span class="mi">4</span>                <span class="mf">0.066</span>  <span class="o">-</span><span class="mf">0.208</span>      <span class="mi">442</span> <span class="mf">11994.607</span>  <span class="mf">70.635</span>
           <span class="n">L</span>                <span class="mf">0.070</span>  <span class="o">-</span><span class="mf">0.444</span>      <span class="mi">442</span>  <span class="mf">6082.012</span>  <span class="mf">34.062</span>
           <span class="n">H</span><span class="o">-</span><span class="n">L</span>             <span class="o">-</span><span class="mf">0.013</span>   <span class="mf">1.631</span>        <span class="mi">0</span> <span class="mf">21456.676</span>  <span class="mf">84.597</span>

 <span class="n">Mean</span> <span class="n">of</span> <span class="n">portfolio</span> <span class="n">returns</span> <span class="nb">sorted</span> <span class="n">on</span> <span class="n">ret_12_1</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>     <span class="mf">0.012</span>
<span class="mi">2</span>     <span class="mf">0.008</span>
<span class="mi">3</span>     <span class="mf">0.007</span>
<span class="mi">4</span>     <span class="mf">0.006</span>
<span class="n">L</span>     <span class="mf">0.005</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>   <span class="mf">0.007</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">futret</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>     <span class="mf">5.836</span>
<span class="mi">2</span>     <span class="mf">4.989</span>
<span class="mi">3</span>     <span class="mf">3.864</span>
<span class="mi">4</span>     <span class="mf">3.393</span>
<span class="n">L</span>     <span class="mf">2.006</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>   <span class="mf">4.215</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">futret</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
                <span class="n">mean</span>  <span class="n">t</span><span class="o">-</span><span class="n">val</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>              <span class="mf">0.012</span>  <span class="mf">5.836</span>
<span class="mi">2</span>              <span class="mf">0.008</span>  <span class="mf">4.989</span>
<span class="mi">3</span>              <span class="mf">0.007</span>  <span class="mf">3.864</span>
<span class="mi">4</span>              <span class="mf">0.006</span>  <span class="mf">3.393</span>
<span class="n">L</span>              <span class="mf">0.005</span>  <span class="mf">2.006</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>            <span class="mf">0.007</span>  <span class="mf">4.215</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>2-D sort<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s make a 5x5 portfolios on char and char2.</span>
<span class="n">char2</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span>
<span class="n">char_class2</span> <span class="o">=</span> <span class="n">char2</span> <span class="o">+</span> <span class="s1">&#39;_class&#39;</span>
<span class="n">split2</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">labels2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;S-B&#39;</span><span class="p">]</span>

<span class="c1"># Classify stocks based on char2 in ascending order.</span>
<span class="n">data</span><span class="p">[</span><span class="n">char_class2</span><span class="p">]</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">char2</span><span class="p">],</span> <span class="n">split2</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Make 5x5 portfolios.</span>
<span class="c1"># qpfs2 will have index = date/char_class/char_class2 and columns = [&#39;futret&#39;].</span>
<span class="n">qpfs2</span> <span class="o">=</span> <span class="n">two_dim_sort</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">char_class2</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="n">weight_col</span><span class="p">)</span>

<span class="c1"># Make char_class2 as columns. Now columns are [&#39;S&#39;, 2, 3, 4, &#39;B&#39;, &#39;S-B&#39;]</span>
<span class="n">qpfs2</span> <span class="o">=</span> <span class="n">qpfs2</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">qpfs2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">qpfs2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Name the portfolios. We relabel after unstacking as `unstack()` sort values.</span>
<span class="n">relabel_class</span><span class="p">(</span><span class="n">qpfs2</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="n">relabel_class</span><span class="p">(</span><span class="n">qpfs2</span><span class="p">,</span> <span class="n">labels2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Calculate the time-series mean and t-value of the future return for each portfolio.</span>
<span class="n">avg</span><span class="p">,</span> <span class="n">tval</span> <span class="o">=</span> <span class="n">time_series_average</span><span class="p">(</span><span class="n">qpfs2</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxlags&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Mean of portfolio returns sorted on </span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">char2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tval</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Mean</span> <span class="n">of</span> <span class="n">portfolio</span> <span class="n">returns</span> <span class="nb">sorted</span> <span class="n">on</span> <span class="n">ret_12_1</span> <span class="ow">and</span> <span class="n">me</span>
<span class="n">me_class</span>           <span class="n">S</span>     <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>     <span class="n">B</span>    <span class="n">S</span><span class="o">-</span><span class="n">B</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>              <span class="mf">0.035</span> <span class="mf">0.016</span> <span class="mf">0.014</span> <span class="mf">0.013</span> <span class="mf">0.010</span>  <span class="mf">0.025</span>
<span class="mi">2</span>              <span class="mf">0.027</span> <span class="mf">0.011</span> <span class="mf">0.010</span> <span class="mf">0.010</span> <span class="mf">0.008</span>  <span class="mf">0.019</span>
<span class="mi">3</span>              <span class="mf">0.025</span> <span class="mf">0.010</span> <span class="mf">0.009</span> <span class="mf">0.008</span> <span class="mf">0.006</span>  <span class="mf">0.019</span>
<span class="mi">4</span>              <span class="mf">0.024</span> <span class="mf">0.009</span> <span class="mf">0.007</span> <span class="mf">0.007</span> <span class="mf">0.006</span>  <span class="mf">0.018</span>
<span class="n">L</span>              <span class="mf">0.030</span> <span class="mf">0.006</span> <span class="mf">0.005</span> <span class="mf">0.005</span> <span class="mf">0.003</span>  <span class="mf">0.027</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>            <span class="mf">0.005</span> <span class="mf">0.010</span> <span class="mf">0.009</span> <span class="mf">0.008</span> <span class="mf">0.007</span> <span class="o">-</span><span class="mf">0.002</span>
<span class="n">me_class</span>            <span class="n">S</span>     <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>     <span class="n">B</span>    <span class="n">S</span><span class="o">-</span><span class="n">B</span>
<span class="n">ret_12_1_class</span>
<span class="n">H</span>              <span class="mf">11.994</span> <span class="mf">6.911</span> <span class="mf">6.089</span> <span class="mf">5.887</span> <span class="mf">5.109</span> <span class="mf">10.926</span>
<span class="mi">2</span>               <span class="mf">9.127</span> <span class="mf">5.415</span> <span class="mf">4.613</span> <span class="mf">5.342</span> <span class="mf">4.725</span>  <span class="mf">8.555</span>
<span class="mi">3</span>               <span class="mf">9.143</span> <span class="mf">4.843</span> <span class="mf">4.072</span> <span class="mf">4.148</span> <span class="mf">3.585</span>  <span class="mf">9.163</span>
<span class="mi">4</span>               <span class="mf">8.261</span> <span class="mf">3.857</span> <span class="mf">3.242</span> <span class="mf">3.303</span> <span class="mf">3.322</span>  <span class="mf">9.258</span>
<span class="n">L</span>               <span class="mf">8.391</span> <span class="mf">2.211</span> <span class="mf">1.796</span> <span class="mf">1.974</span> <span class="mf">1.405</span> <span class="mf">10.429</span>
<span class="n">H</span><span class="o">-</span><span class="n">L</span>             <span class="mf">2.293</span> <span class="mf">5.520</span> <span class="mf">5.356</span> <span class="mf">4.905</span> <span class="mf">4.077</span> <span class="o">-</span><span class="mf">1.411</span>
</pre></div>
</div>
</section>
<section id="firm-level-cross-sectional-regression">
<h3>Firm-level cross-sectional regression<a class="headerlink" href="#firm-level-cross-sectional-regression" title="Permalink to this headline"></a></h3>
<p>Regress return cross-sectionally on the t-1 characteristic and other variables at each date t.
Take the time-series average of the coefficients and examine their significance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># X: For simplicity, we will only use the characteristic and the size.</span>
<span class="n">exog_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">char</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">]</span>

<span class="c1"># Run the regressions. This function returns the average coefficients, t-values, and coefficients time-series.</span>
<span class="n">avg</span><span class="p">,</span> <span class="n">tval</span><span class="p">,</span> <span class="n">coef</span> <span class="o">=</span> <span class="n">crosssectional_regression</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">exog_cols</span><span class="p">,</span> <span class="n">add_constant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;HAC&#39;</span><span class="p">,</span>
                                            <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxlags&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mean of the coefficients&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">avg</span><span class="p">,</span> <span class="n">tval</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Coefficients time-series&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mean</span> <span class="n">of</span> <span class="n">the</span> <span class="n">coefficients</span>
           <span class="n">mean</span>  <span class="n">t</span><span class="o">-</span><span class="n">stat</span>
<span class="n">const</span>     <span class="mf">0.012</span>   <span class="mf">5.838</span>
<span class="n">ret_12_1</span>  <span class="mf">0.007</span>   <span class="mf">4.177</span>
<span class="n">me</span>       <span class="o">-</span><span class="mf">0.000</span>  <span class="o">-</span><span class="mf">2.450</span>

<span class="n">Coefficients</span> <span class="n">time</span><span class="o">-</span><span class="n">series</span>
            <span class="n">const</span>  <span class="n">ret_12_1</span>     <span class="n">me</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.015</span>     <span class="mf">0.005</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mf">0.064</span>    <span class="o">-</span><span class="mf">0.018</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="o">-</span><span class="mf">0.025</span>     <span class="mf">0.046</span>  <span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="o">-</span><span class="mf">0.012</span>     <span class="mf">0.050</span>  <span class="mf">0.000</span>
           <span class="o">...</span>       <span class="o">...</span>    <span class="o">...</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span> <span class="o">-</span><span class="mf">0.031</span>     <span class="mf">0.012</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.028</span>    <span class="o">-</span><span class="mf">0.013</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mf">0.194</span>     <span class="mf">0.008</span> <span class="o">-</span><span class="mf">0.000</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.087</span>    <span class="o">-</span><span class="mf">0.013</span> <span class="o">-</span><span class="mf">0.000</span>
</pre></div>
</div>
</section>
<section id="factor-regression">
<h3>Factor regression<a class="headerlink" href="#factor-regression" title="Permalink to this headline"></a></h3>
<p>Regress the long-short portfolio (H-L) returns on the FF-3 factors.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample period.</span>
<span class="n">sdate</span> <span class="o">=</span> <span class="s1">&#39;1952-01&#39;</span>
<span class="n">edate</span> <span class="o">=</span> <span class="s1">&#39;2020-12&#39;</span>

<span class="c1"># Read factors.</span>
<span class="c1"># Here I use the factors generated by PyAnomaly. You can use different sources if you like.</span>
<span class="n">factors</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">factors_monthly_fname</span><span class="p">)</span>
<span class="c1"># factors = WRDS.read_data(&#39;factors_monthly&#39;)  # factors from K.French website.</span>

<span class="n">qpfs</span> <span class="o">=</span> <span class="n">qpfs</span><span class="p">[</span><span class="n">sdate</span><span class="p">:</span><span class="n">edate</span><span class="p">]</span>
<span class="n">factors</span> <span class="o">=</span> <span class="n">factors</span><span class="p">[</span><span class="n">sdate</span><span class="p">:</span><span class="n">edate</span><span class="p">]</span>

<span class="c1"># X: Constant + FF3.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sdate</span><span class="p">:</span><span class="n">edate</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mktrf&#39;</span><span class="p">,</span> <span class="s1">&#39;smb_ff&#39;</span><span class="p">,</span> <span class="s1">&#39;hml&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># X = factors.loc[sdate:edate, [&#39;mktrf&#39;, &#39;smb&#39;, &#39;hml&#39;]].values  # If you use K. French data.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Run the regression for each portfolio.</span>
<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="n">qpfs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># y: Returns of a portfolio</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">qpfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">pf</span><span class="p">),</span> <span class="s1">&#39;futret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="c1"># Make an output table.</span>
    <span class="n">result</span><span class="p">[</span><span class="n">pf</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;coefs&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s1">&#39;tval&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;mktrf&#39;</span><span class="p">,</span> <span class="s1">&#39;smb&#39;</span><span class="p">,</span> <span class="s1">&#39;hml&#39;</span><span class="p">])</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Factor regression: FF3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Factor</span> <span class="n">regression</span><span class="p">:</span> <span class="n">FF3</span>
           <span class="n">H</span>              <span class="mi">2</span>             <span class="mi">3</span>             <span class="mi">4</span>             <span class="n">L</span>           <span class="n">H</span><span class="o">-</span><span class="n">L</span>
       <span class="n">coefs</span>    <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>   <span class="n">tval</span>  <span class="n">coefs</span>    <span class="n">tval</span>
<span class="n">const</span>  <span class="mf">0.005</span>   <span class="mf">7.125</span>  <span class="mf">0.002</span>  <span class="mf">3.685</span>  <span class="mf">0.000</span>  <span class="mf">0.925</span> <span class="o">-</span><span class="mf">0.001</span> <span class="o">-</span><span class="mf">2.154</span> <span class="o">-</span><span class="mf">0.005</span> <span class="o">-</span><span class="mf">5.758</span>  <span class="mf">0.011</span>   <span class="mf">7.424</span>
<span class="n">mktrf</span>  <span class="mf">1.028</span>  <span class="mf">56.623</span>  <span class="mf">0.964</span> <span class="mf">79.587</span>  <span class="mf">0.951</span> <span class="mf">87.918</span>  <span class="mf">1.004</span> <span class="mf">77.950</span>  <span class="mf">1.223</span> <span class="mf">56.655</span> <span class="o">-</span><span class="mf">0.195</span>  <span class="o">-</span><span class="mf">5.705</span>
<span class="n">smb</span>    <span class="mf">0.201</span>   <span class="mf">7.141</span> <span class="o">-</span><span class="mf">0.111</span> <span class="o">-</span><span class="mf">5.907</span> <span class="o">-</span><span class="mf">0.093</span> <span class="o">-</span><span class="mf">5.537</span> <span class="o">-</span><span class="mf">0.028</span> <span class="o">-</span><span class="mf">1.423</span>  <span class="mf">0.258</span>  <span class="mf">7.718</span> <span class="o">-</span><span class="mf">0.057</span>  <span class="o">-</span><span class="mf">1.082</span>
<span class="n">hml</span>   <span class="o">-</span><span class="mf">0.479</span> <span class="o">-</span><span class="mf">22.131</span> <span class="o">-</span><span class="mf">0.097</span> <span class="o">-</span><span class="mf">6.720</span>  <span class="mf">0.100</span>  <span class="mf">7.717</span>  <span class="mf">0.312</span> <span class="mf">20.317</span>  <span class="mf">0.587</span> <span class="mf">22.812</span> <span class="o">-</span><span class="mf">1.066</span> <span class="o">-</span><span class="mf">26.172</span>
</pre></div>
</div>
</section>
</section>
<section id="example-6">
<h2>Example 6<a class="headerlink" href="#example-6" title="Permalink to this headline"></a></h2>
<p><strong>Quantile portfolio construction and performance evaluation.</strong></p>
<p>This example demonstrates how to construct quantile portfolios (and the long-short) based on a firm characteristic
and evaluate their performance.</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>Tercile portfolios will be generated from the 12-month momentum.</p></li>
<li><p>Different ways of setting the transaction cost will shown.</p></li>
</ol>
</div></blockquote>
<ul class="simple">
<li><p>It is assumed that the firm characteristic has been created and saved to ‘crspm.pickle’.</p></li>
</ul>
<p>See also <a class="reference internal" href="pyanomaly_edited.html#pyanomaly-jkp"><span class="std std-ref">pyanomaly.jkp</span></a> module for factor and characteristic portfolio creation replicating JKP’s SAS code.</p>
<section id="id2">
<h3>Set variables<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;ret_12_1&#39;</span>  <span class="c1"># 12-month momentum</span>
<span class="n">char_class</span> <span class="o">=</span> <span class="n">char</span> <span class="o">+</span> <span class="s1">&#39;_class&#39;</span>  <span class="c1"># Group column: portfolio-stock mapping</span>
<span class="n">ret_col</span> <span class="o">=</span> <span class="s1">&#39;futret&#39;</span>  <span class="c1"># Future return column</span>
<span class="n">weight_col</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span>  <span class="c1"># Market equity column</span>
<span class="n">split</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Tercile. You can also do split = [0.2, 0.8] for 2:6:2 split.</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]</span>  <span class="c1"># Portfolio names: &#39;H-L&#39; for long short.</span>
</pre></div>
</div>
</section>
<section id="id3">
<h3>Load data<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read crspm data (not raw data but the output data).</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="s1">&#39;crspm&#39;</span><span class="p">)</span>

<span class="c1"># If you want to exclude bottom 20% based on NYSE size...</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">exchcd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">weight_col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># NYSE me</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;nyse_me&#39;</span><span class="p">)</span>

<span class="c1"># Make the future return. If it&#39;s already in the data, this step can be skipped.</span>
<span class="n">data</span><span class="p">[</span><span class="n">ret_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_future_return</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">])</span>

<span class="c1"># Let&#39;s just keep the data we need. Below is the same as `data = data[[char, ret_col, weight_col]]`</span>
<span class="c1"># but faster and more memroy efficient.</span>
<span class="n">keep_columns</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">char</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">])</span>

<span class="c1"># Risk-free rates.</span>
<span class="c1"># Don&#39;t forget to set `month_end=True` since the crspm date has also been shifted to month end.</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">WRDS</span><span class="o">.</span><span class="n">get_risk_free_rate</span><span class="p">(</span><span class="n">month_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="transaction-costs">
<h3>Transaction costs<a class="headerlink" href="#transaction-costs" title="Permalink to this headline"></a></h3>
<p>PyAnomaly provides a powerful way to set transaction costs via <code class="docutils literal notranslate"><span class="pre">TransactionCost</span></code> class.
For example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># No transaction costs.</span>
<span class="n">costfcn</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Transaction cost of 30 basis points.</span>
<span class="n">costfcn</span> <span class="o">=</span> <span class="mf">0.003</span>

<span class="c1"># 20 (30) bps when buying (selling).</span>
<span class="n">costfcn</span> <span class="o">=</span> <span class="n">TransactionCost</span><span class="p">(</span><span class="n">buy_linear</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">sell_linear</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="pyanomaly_edited.html#pyanomaly-tcost"><span class="std std-ref">pyanomaly.tcost</span></a> module for details.
In this example, we will assume transaction cost that decreases over time and with size.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">costfcn</span> <span class="o">=</span> <span class="n">TimeVaryingCost</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">weight_col</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="portfolio-construction">
<h3>Portfolio construction<a class="headerlink" href="#portfolio-construction" title="Permalink to this headline"></a></h3>
<p>In PyAnomaly, <code class="docutils literal notranslate"><span class="pre">Portfolio</span></code> class is used to make a portfolio from position information.
The <code class="docutils literal notranslate"><span class="pre">make_position()</span></code> function converts a panel data to position data that is used as the input to <code class="docutils literal notranslate"><span class="pre">Portfolio</span></code> class.
In <cite>data</cite>, the future return at t is the return between t and t+1, whereas in the position data, dates are shifted
so that the future return at t is the return between t-1 and t.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Classify data on char. The highest momentum stock will be labeled 0 and the lowest 2.</span>
<span class="n">data</span><span class="p">[</span><span class="n">char_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">classify</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">char</span><span class="p">],</span> <span class="n">split</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Make position data.</span>
<span class="c1"># Set weight_col = None for equally-weighted portfolios.</span>
<span class="c1"># `other_cols` are the columns you want to keep in the position data.</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">make_position</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ret_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">other_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Make portfolios. `portfolios` will have four portfolios, &#39;H&#39;, &#39;M&#39;, &#39;L&#39;, and &#39;H-L&#39;.</span>
<span class="n">portfolios</span> <span class="o">=</span> <span class="n">make_quantile_portfolios</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">char_class</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span> <span class="n">costfcn</span><span class="o">=</span><span class="n">costfcn</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="performance-evaluation">
<h3>Performance evaluation<a class="headerlink" href="#performance-evaluation" title="Permalink to this headline"></a></h3>
<p>Portfolios can be evaluated using <code class="docutils literal notranslate"><span class="pre">Portfolio.eval()</span></code> for a single portfolio or <code class="docutils literal notranslate"><span class="pre">Portfolios.eval()</span></code> for a
collection of portfolios.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># `annualize_factor=12` will annualize the results as crspm is monthly data.</span>
<span class="n">pfperfs</span><span class="p">,</span> <span class="n">pfvals</span> <span class="o">=</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">annualize_factor</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Performance metrics.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performance&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pfperfs</span><span class="p">)</span>

<span class="c1"># Time-series of portfolio value, return, ...</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Values&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pfvals</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performance</span>
                    <span class="n">H</span>           <span class="n">M</span>           <span class="n">L</span>         <span class="n">H</span><span class="o">-</span><span class="n">L</span>
<span class="n">mean</span>            <span class="mf">0.042</span>      <span class="o">-</span><span class="mf">0.032</span>      <span class="o">-</span><span class="mf">0.029</span>      <span class="o">-</span><span class="mf">0.114</span>
<span class="n">std</span>             <span class="mf">0.195</span>       <span class="mf">0.190</span>       <span class="mf">0.247</span>       <span class="mf">0.167</span>
<span class="n">sharpe</span>          <span class="mf">0.215</span>      <span class="o">-</span><span class="mf">0.170</span>      <span class="o">-</span><span class="mf">0.118</span>      <span class="o">-</span><span class="mf">0.681</span>
<span class="n">cum</span>             <span class="mf">5.176</span>      <span class="o">-</span><span class="mf">1.661</span>      <span class="o">-</span><span class="mf">2.466</span>     <span class="o">-</span><span class="mf">12.287</span>
<span class="n">mdd</span>             <span class="mf">0.818</span>       <span class="mf">0.985</span>       <span class="mf">0.990</span>       <span class="mf">1.000</span>
<span class="n">mdd</span> <span class="n">start</span>  <span class="mi">1929</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1929</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1929</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>
<span class="n">mdd</span> <span class="n">end</span>    <span class="mi">1942</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">1982</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1982</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>
<span class="n">msd</span>             <span class="mf">0.422</span>       <span class="mf">0.505</span>       <span class="mf">0.608</span>       <span class="mf">0.784</span>
<span class="n">msd</span> <span class="n">start</span>  <span class="mi">1937</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>
<span class="n">msd</span> <span class="n">end</span>    <span class="mi">1938</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">1932</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">30</span>
<span class="n">turnover</span>        <span class="mf">5.614</span>       <span class="mf">7.738</span>       <span class="mf">6.260</span>      <span class="mf">12.263</span>
<span class="n">lposition</span>     <span class="mf">456.613</span>     <span class="mf">458.740</span>     <span class="mf">458.704</span>     <span class="mf">456.613</span>
<span class="n">sposition</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>     <span class="mf">458.704</span>

<span class="n">Values</span>
              <span class="n">ret</span>  <span class="n">exret</span>       <span class="n">val1</span>        <span class="n">val</span> <span class="n">lposition</span> <span class="n">sposition</span>    <span class="n">cost</span> <span class="n">tover</span> <span class="n">netret</span> <span class="n">grossret</span> <span class="n">netexret</span> <span class="n">grossexret</span> <span class="n">cumret</span> <span class="n">drawdown</span> <span class="n">drawdur</span>  <span class="n">drawstart</span> <span class="n">succdown</span> <span class="n">succdur</span>  <span class="n">succstart</span>
                <span class="n">H</span>      <span class="n">H</span>          <span class="n">H</span>          <span class="n">H</span>         <span class="n">H</span>         <span class="n">H</span>       <span class="n">H</span>     <span class="n">H</span>      <span class="n">H</span>        <span class="n">H</span>        <span class="n">H</span>          <span class="n">H</span>      <span class="n">H</span>        <span class="n">H</span>       <span class="n">H</span>          <span class="n">H</span>        <span class="n">H</span>       <span class="n">H</span>          <span class="n">H</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.001</span> <span class="o">-</span><span class="mf">0.002</span>      <span class="mf">1.001</span>      <span class="mf">1.000</span>       <span class="mi">120</span>     <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mf">0.000</span>  <span class="mf">0.001</span>    <span class="mf">0.001</span>   <span class="o">-</span><span class="mf">0.002</span>     <span class="o">-</span><span class="mf">0.002</span>  <span class="mf">0.001</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mf">0.041</span>  <span class="mf">0.039</span>      <span class="mf">1.050</span>      <span class="mf">1.001</span>       <span class="mi">122</span>     <span class="mf">0.000</span>   <span class="mf">0.008</span> <span class="mf">0.415</span>  <span class="mf">0.041</span>    <span class="mf">0.049</span>    <span class="mf">0.039</span>      <span class="mf">0.046</span>  <span class="mf">0.041</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.010</span>  <span class="mf">0.007</span>      <span class="mf">1.073</span>      <span class="mf">1.050</span>       <span class="mi">123</span>     <span class="mf">0.000</span>   <span class="mf">0.013</span> <span class="mf">0.720</span>  <span class="mf">0.010</span>    <span class="mf">0.022</span>    <span class="mf">0.007</span>      <span class="mf">0.019</span>  <span class="mf">0.051</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>
           <span class="o">...</span>    <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>     <span class="o">...</span>   <span class="o">...</span>    <span class="o">...</span>      <span class="o">...</span>      <span class="o">...</span>        <span class="o">...</span>    <span class="o">...</span>      <span class="o">...</span>     <span class="o">...</span>        <span class="o">...</span>      <span class="o">...</span>     <span class="o">...</span>        <span class="o">...</span>    <span class="o">...</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span> <span class="o">-</span><span class="mf">0.028</span> <span class="o">-</span><span class="mf">0.028</span> <span class="mf">246929.635</span> <span class="mf">253650.609</span>       <span class="mi">726</span>     <span class="mf">0.000</span> <span class="mf">280.481</span> <span class="mf">0.197</span> <span class="o">-</span><span class="mf">0.028</span>   <span class="o">-</span><span class="mf">0.026</span>   <span class="o">-</span><span class="mf">0.028</span>     <span class="o">-</span><span class="mf">0.027</span>  <span class="mf">5.039</span>    <span class="mf">0.077</span>   <span class="mf">2.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.077</span>   <span class="mf">2.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mf">0.101</span>  <span class="mf">0.101</span> <span class="mf">272302.967</span> <span class="mf">246929.635</span>       <span class="mi">727</span>     <span class="mf">0.000</span> <span class="mf">310.721</span> <span class="mf">0.222</span>  <span class="mf">0.101</span>    <span class="mf">0.103</span>    <span class="mf">0.101</span>      <span class="mf">0.103</span>  <span class="mf">5.135</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.041</span>  <span class="mf">0.041</span> <span class="mf">283833.135</span> <span class="mf">272302.967</span>       <span class="mi">736</span>     <span class="mf">0.000</span> <span class="mf">306.903</span> <span class="mf">0.197</span>  <span class="mf">0.041</span>    <span class="mf">0.042</span>    <span class="mf">0.041</span>      <span class="mf">0.042</span>  <span class="mf">5.176</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.000</span>   <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>
</pre></div>
</div>
<p>Let’s plot cumulative returns.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pfvals</span><span class="p">[</span><span class="s1">&#39;cumret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<a class="reference internal image-reference" href="_images/example6_plot1.png"><img alt="_images/example6_plot1.png" class="align-center" src="_images/example6_plot1.png" style="width: 500px;" /></a>
<p>You can also plot selected portfolios.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pfvals</span><span class="p">[</span><span class="s1">&#39;cumret&#39;</span><span class="p">][[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<a class="reference internal image-reference" href="_images/example6_plot2.png"><img alt="_images/example6_plot2.png" class="align-center" src="_images/example6_plot2.png" style="width: 500px;" /></a>
<p>You can evaluate the portfolios for a sub-period and choose to ignore transaction costs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pfperfs1</span><span class="p">,</span> <span class="n">pfvals1</span> <span class="o">=</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">sdate</span><span class="o">=</span><span class="s1">&#39;2001-01-01&#39;</span><span class="p">,</span> <span class="n">edate</span><span class="o">=</span><span class="s1">&#39;2010-12-31&#39;</span><span class="p">,</span> <span class="n">annualize_factor</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">consider_cost</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performance: 2001-01 - 2010-12&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pfperfs1</span><span class="p">)</span>
<span class="n">pfvals1</span><span class="p">[</span><span class="s1">&#39;cumret&#39;</span><span class="p">][[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;H-L&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performance</span><span class="p">:</span> <span class="mi">2001</span><span class="o">-</span><span class="mi">01</span> <span class="o">-</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">12</span>
                    <span class="n">H</span>           <span class="n">M</span>           <span class="n">L</span>         <span class="n">H</span><span class="o">-</span><span class="n">L</span>
<span class="n">mean</span>            <span class="mf">0.054</span>       <span class="mf">0.023</span>       <span class="mf">0.033</span>       <span class="mf">0.020</span>
<span class="n">std</span>             <span class="mf">0.169</span>       <span class="mf">0.149</span>       <span class="mf">0.256</span>       <span class="mf">0.201</span>
<span class="n">sharpe</span>          <span class="mf">0.318</span>       <span class="mf">0.154</span>       <span class="mf">0.130</span>       <span class="mf">0.102</span>
<span class="n">cum</span>             <span class="mf">0.605</span>       <span class="mf">0.330</span>       <span class="mf">0.219</span>      <span class="o">-</span><span class="mf">0.011</span>
<span class="n">mdd</span>             <span class="mf">0.507</span>       <span class="mf">0.447</span>       <span class="mf">0.628</span>       <span class="mf">0.470</span>
<span class="n">mdd</span> <span class="n">start</span>  <span class="mi">2007</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2007</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2007</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>
<span class="n">mdd</span> <span class="n">end</span>    <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>
<span class="n">msd</span>             <span class="mf">0.398</span>       <span class="mf">0.255</span>       <span class="mf">0.396</span>       <span class="mf">0.402</span>
<span class="n">msd</span> <span class="n">start</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>
<span class="n">msd</span> <span class="n">end</span>    <span class="mi">2008</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">2008</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mi">2009</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>
<span class="n">turnover</span>        <span class="mf">6.308</span>       <span class="mf">7.591</span>       <span class="mf">6.138</span>      <span class="mf">12.930</span>
<span class="n">lposition</span>     <span class="mf">669.283</span>     <span class="mf">673.458</span>     <span class="mf">672.458</span>     <span class="mf">669.283</span>
<span class="n">sposition</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>       <span class="mf">0.000</span>     <span class="mf">672.458</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/example6_plot3.png"><img alt="_images/example6_plot3.png" class="align-center" src="_images/example6_plot3.png" style="width: 500px;" /></a>
<p>You can access one of the portfolios, evaluate it, and view its position details.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># To access portfolio &#39;H&#39;</span>
<span class="n">pf_h</span> <span class="o">=</span> <span class="n">portfolios</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span>
<span class="n">pf_h_perf</span><span class="p">,</span> <span class="n">pf_h_val</span> <span class="o">=</span> <span class="n">pf_h</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># no annualize</span>

<span class="c1"># You can also access the returns of `eval()` as follows.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performance: H&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pf_h</span><span class="o">.</span><span class="n">performance</span><span class="p">)</span>  <span class="c1"># pf_h_perf</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Values: H&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pf_h</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># pf_h_val</span>

<span class="c1"># To see the positions (constituents)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Positions: H&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pf_h</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Performance</span><span class="p">:</span> <span class="n">H</span>
                    <span class="n">H</span>
<span class="n">mean</span>            <span class="mf">0.004</span>
<span class="n">std</span>             <span class="mf">0.056</span>
<span class="n">sharpe</span>          <span class="mf">0.062</span>
<span class="n">cum</span>             <span class="mf">5.176</span>
<span class="n">mdd</span>             <span class="mf">0.818</span>
<span class="n">mdd</span> <span class="n">start</span>  <span class="mi">1929</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>
<span class="n">mdd</span> <span class="n">end</span>    <span class="mi">1942</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>
<span class="n">msd</span>             <span class="mf">0.422</span>
<span class="n">msd</span> <span class="n">start</span>  <span class="mi">1937</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">31</span>
<span class="n">msd</span> <span class="n">end</span>    <span class="mi">1938</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>
<span class="n">turnover</span>        <span class="mf">0.468</span>
<span class="n">lposition</span>     <span class="mf">456.613</span>
<span class="n">sposition</span>       <span class="mf">0.000</span>

<span class="n">Values</span><span class="p">:</span> <span class="n">H</span>
              <span class="n">ret</span>  <span class="n">exret</span>       <span class="n">val1</span>        <span class="n">val</span>  <span class="n">lposition</span>  <span class="n">sposition</span>    <span class="n">cost</span>  <span class="n">tover</span>  <span class="n">netret</span>  <span class="n">grossret</span>  <span class="n">netexret</span>  <span class="n">grossexret</span>  <span class="n">cumret</span>  <span class="n">drawdown</span>  <span class="n">drawdur</span>  <span class="n">drawstart</span>  <span class="n">succdown</span>  <span class="n">succdur</span>  <span class="n">succstart</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.001</span> <span class="o">-</span><span class="mf">0.002</span>      <span class="mf">1.001</span>      <span class="mf">1.000</span>        <span class="mi">120</span>      <span class="mf">0.000</span>   <span class="mf">0.000</span>  <span class="mf">0.000</span>   <span class="mf">0.001</span>     <span class="mf">0.001</span>    <span class="o">-</span><span class="mf">0.002</span>      <span class="o">-</span><span class="mf">0.002</span>   <span class="mf">0.001</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>  <span class="mf">0.041</span>  <span class="mf">0.039</span>      <span class="mf">1.050</span>      <span class="mf">1.001</span>        <span class="mi">122</span>      <span class="mf">0.000</span>   <span class="mf">0.008</span>  <span class="mf">0.415</span>   <span class="mf">0.041</span>     <span class="mf">0.049</span>     <span class="mf">0.039</span>       <span class="mf">0.046</span>   <span class="mf">0.041</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.010</span>  <span class="mf">0.007</span>      <span class="mf">1.073</span>      <span class="mf">1.050</span>        <span class="mi">123</span>      <span class="mf">0.000</span>   <span class="mf">0.013</span>  <span class="mf">0.720</span>   <span class="mf">0.010</span>     <span class="mf">0.022</span>     <span class="mf">0.007</span>       <span class="mf">0.019</span>   <span class="mf">0.051</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">1927</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>
           <span class="o">...</span>    <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>     <span class="o">...</span>    <span class="o">...</span>     <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>         <span class="o">...</span>     <span class="o">...</span>       <span class="o">...</span>      <span class="o">...</span>        <span class="o">...</span>       <span class="o">...</span>      <span class="o">...</span>        <span class="o">...</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">31</span> <span class="o">-</span><span class="mf">0.028</span> <span class="o">-</span><span class="mf">0.028</span> <span class="mf">246929.635</span> <span class="mf">253650.609</span>        <span class="mi">726</span>      <span class="mf">0.000</span> <span class="mf">280.481</span>  <span class="mf">0.197</span>  <span class="o">-</span><span class="mf">0.028</span>    <span class="o">-</span><span class="mf">0.026</span>    <span class="o">-</span><span class="mf">0.028</span>      <span class="o">-</span><span class="mf">0.027</span>   <span class="mf">5.039</span>     <span class="mf">0.077</span>    <span class="mf">2.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>     <span class="mf">0.077</span>    <span class="mf">2.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>  <span class="mf">0.101</span>  <span class="mf">0.101</span> <span class="mf">272302.967</span> <span class="mf">246929.635</span>        <span class="mi">727</span>      <span class="mf">0.000</span> <span class="mf">310.721</span>  <span class="mf">0.222</span>   <span class="mf">0.101</span>     <span class="mf">0.103</span>     <span class="mf">0.101</span>       <span class="mf">0.103</span>   <span class="mf">5.135</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mf">0.041</span>  <span class="mf">0.041</span> <span class="mf">283833.135</span> <span class="mf">272302.967</span>        <span class="mi">736</span>      <span class="mf">0.000</span> <span class="mf">306.903</span>  <span class="mf">0.197</span>   <span class="mf">0.041</span>     <span class="mf">0.042</span>     <span class="mf">0.041</span>       <span class="mf">0.042</span>   <span class="mf">5.176</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>     <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>

<span class="n">Positions</span><span class="p">:</span> <span class="n">H</span>
               <span class="nb">id</span>    <span class="n">ret</span>   <span class="n">wgt</span>    <span class="n">rf</span>  <span class="n">exret</span>      <span class="n">val</span>     <span class="n">val1</span>     <span class="n">val0</span>   <span class="n">cost</span>
<span class="n">date</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">10049</span> <span class="o">-</span><span class="mf">0.027</span> <span class="mf">0.004</span> <span class="mf">0.002</span> <span class="o">-</span><span class="mf">0.030</span>    <span class="mf">0.004</span>    <span class="mf">0.003</span>    <span class="mf">0.004</span>  <span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">10102</span> <span class="o">-</span><span class="mf">0.018</span> <span class="mf">0.002</span> <span class="mf">0.002</span> <span class="o">-</span><span class="mf">0.020</span>    <span class="mf">0.002</span>    <span class="mf">0.002</span>    <span class="mf">0.002</span>  <span class="mf">0.000</span>
<span class="mi">1927</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">10129</span> <span class="o">-</span><span class="mf">0.007</span> <span class="mf">0.003</span> <span class="mf">0.002</span> <span class="o">-</span><span class="mf">0.009</span>    <span class="mf">0.003</span>    <span class="mf">0.003</span>    <span class="mf">0.003</span>  <span class="mf">0.000</span>
           <span class="o">...</span>    <span class="o">...</span>   <span class="o">...</span>   <span class="o">...</span>    <span class="o">...</span>      <span class="o">...</span>      <span class="o">...</span>      <span class="o">...</span>    <span class="o">...</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">93369</span>  <span class="mf">0.184</span> <span class="mf">0.000</span> <span class="mf">0.000</span>  <span class="mf">0.184</span>   <span class="mf">32.099</span>   <span class="mf">38.018</span>   <span class="mf">31.771</span>  <span class="mf">0.002</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">93393</span>  <span class="mf">0.092</span> <span class="mf">0.000</span> <span class="mf">0.000</span>  <span class="mf">0.092</span>   <span class="mf">13.010</span>   <span class="mf">14.207</span>   <span class="mf">12.877</span>  <span class="mf">0.001</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>  <span class="mi">93436</span>  <span class="mf">0.243</span> <span class="mf">0.027</span> <span class="mf">0.000</span>  <span class="mf">0.243</span> <span class="mf">7299.521</span> <span class="mf">9075.147</span> <span class="mf">7225.128</span>  <span class="mf">0.391</span>
</pre></div>
</div>
</section>
</section>
<section id="example-7">
<h2>Example 7<a class="headerlink" href="#example-7" title="Permalink to this headline"></a></h2>
<p><strong>New table download.</strong></p>
<p>This example demonstrates how to download a new table from WRDS.
Different ways of downloading <cite>comp.secm</cite> table are demonstrated.</p>
<p>Connect to WRDS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span> <span class="o">=</span> <span class="n">WRDS</span><span class="p">(</span><span class="n">wrds_usename</span><span class="p">)</span>
</pre></div>
</div>
<p>Method 1: Download the entire table at once.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span><span class="o">.</span><span class="n">download_table</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span>  <span class="c1"># &#39;datadate&#39;s type will be converted to datetime.</span>
</pre></div>
</div>
<p>Method 2: Download the entire table asynchronously.</p>
<p>This downloads data every <cite>interval</cite> years along <cite>data_col</cite>. This is a memory efficient way of downloading a large dataset.
For a small size data, this can be slower than <code class="docutils literal notranslate"><span class="pre">download_table()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wrds</span><span class="o">.</span><span class="n">download_table_async</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">],</span> <span class="n">interval</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Method 3: Download only some fields.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;datadate, gvkey, cshoq, prccm&#39;</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">download_table_async</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Method 4: Download data using a complete query statement.</p>
<p>Below is equivalent to the above.
Note that the query statement must contain ‘WHERE [<cite>date_col</cite>] BETWEEN {} and {}’.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT datadate, gvkey, cshoq, prccm</span>
<span class="s2">    FROM comp.secm</span>
<span class="s2">    WHERE datadate between &#39;</span><span class="se">{{}}</span><span class="s2">&#39; and &#39;</span><span class="se">{{}}</span><span class="s2">&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">wrds</span><span class="o">.</span><span class="n">download_table_async</span><span class="p">(</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;secm&#39;</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="bulding-your-own">
<h1>Bulding Your Own<a class="headerlink" href="#bulding-your-own" title="Permalink to this headline"></a></h1>
<p>PyAnomaly is highly configurable and customizable, and you can easily add new firm characteristics or functions.
When you make modifications, do not change the original source directly. Rather, add new modules (files) and define subclasses if necessary.
This is because the library can be updated in the future, and if you change the original source, you will lose the changes you made when you
update the library.</p>
<section id="making-your-own-list-of-characteristics">
<h2>Making your own list of characteristics<a class="headerlink" href="#making-your-own-list-of-characteristics" title="Permalink to this headline"></a></h2>
<p>If you want generate a subset of all available firm characteristics, you can add a new acronym column in ‘mapping.xlsx’.
Alternatively, you can simply define a list of characteristics in a python module and use it as input to panel.create_chars().
In this case, you need to use the method names and cannot define aliases for the firm characteristics.</p>
</section>
<section id="adding-a-new-characteristic">
<h2>Adding a new characteristic<a class="headerlink" href="#adding-a-new-characteristic" title="Permalink to this headline"></a></h2>
<p>Where to add a method to define a new characteristic depends on what data it requires. If it only requires data from FUNDA (plus market equity from CRSPM),
you can define a class inheriting FUNDA class and add the method in it. Similary, if the characteristic only requires data from CRSPM, you can define a class
inheriting CRSPM. If the characteristic requires data from multiple data sources, you can inherit Merged class.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">myFUNDA</span><span class="p">(</span><span class="n">FUNDA</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_my_char</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">fa</span><span class="o">.</span><span class="n">y</span>

                <span class="k">return</span> <span class="n">char</span>
</pre></div>
</div>
<p>Note that the method’s name starts with ‘<a href="#id4"><span class="problematic" id="id5">c_</span></a>’. This is one of few coding rules you need to follow.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="pyanomaly_edited.html" class="btn btn-neutral float-right" title="pyanomaly" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Chulwoo Han and Jongho Kang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>